<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="WARREN's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="WARREN's blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WARREN's blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>WARREN's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WARREN's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/05/Inception-and-Supervisor-installation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WARREN's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/05/Inception-and-Supervisor-installation/" itemprop="url">Inception的安装以及用Supervisor管理Inception自启动的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-05T10:08:32+08:00">
                2016-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/Inception/" itemprop="url" rel="index">
                    <span itemprop="name">Inception</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/Inception/Supervisor/" itemprop="url" rel="index">
                    <span itemprop="name">Supervisor</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>操作系统</strong> ：Centos 6.4 64位</p>
<h4 id="Inception的安装"><a href="#Inception的安装" class="headerlink" title="Inception的安装"></a>Inception的安装</h4><p><strong>简介</strong></p>
<p><code>Inception</code>是集审核、执行、回滚于一体的一个自动化运维系统，它是根据<code>MySQL</code>代码修改过来的，用它可以很明确的，详细的，准确的审核MySQL的<code>SQL</code>语句，它的工作模式和MySQL完全相同，可以直接使用MySQL客户端来连接，但不需要验证权限，它相对应用程序（上层审核流程系统等）而言，是一个服务器，在连接时需要指定服务器地址及Inception服务器的端口即可，而它相对要审核或执行的语句所对应的线上MySQL服务器来说，是一个客户端，它在内部需要实时的连接数据库服务器来获取所需要的信息，或者直接在在线上执行相应的语句及获取<code>binlog</code>等，Inception就是一个中间性质的服务。</p>
<p><code>Inception</code>提供的功能很丰富：</p>
<ul>
<li>它可以对提交的所有语句的语法分析，如果语法有问题，都会将相应的错误信息返回给审核者。 </li>
<li>提供语义分析，当一个表，库，列等信息不正确或者不符合规范的时候报错，或者使用了一个不存在的对象时报错等等。 </li>
<li>提供了很多针对SQL规范性约束的功能，这些DBA都是可以通过系统参数来配置的。 </li>
<li>更高级的功能是，可以辅助DBA分析一条查询语句的性能，如果没有使用索引或者某些原因导致查询很慢，都可以检查。</li>
<li>提供SQL语句的执行功能，可执行的语句类型包括常用的<code>DML</code>及<code>DDL</code>语句及<code>truncate table</code>等操作。</li>
<li>Inception 在执行 <code>DML</code> 时还提供生成回滚语句的功能，对应的操作记录及回滚语句会被存储在备份机器上面，备份机器通过配置Inception参数来指定。</li>
</ul>
<p>Inception是一款自动化运维的利器，有别与现在各个公司使用的方式，使用Inception，将会给DBA带来最大的便利性，将DBA从繁冗的工作中解放出来，做一些更多的自动化工作，或者从架构方面研究如何更大程度的保证数据库的高可用等等。</p>
<p><strong>依赖条件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y cmake ncurses-devel openssl-devel bison-devel gcc-c++</div></pre></td></tr></table></figure>
<p><strong>下载及编译</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/mysql-inception/inception.git</div><div class="line">cd inception</div><div class="line">./inception_build.sh debug</div></pre></td></tr></table></figure>
<p>每次如果出错之后，需要把编译目录删除掉<code>rm -rf debug</code>，重新执行，不然会执行出错。</p>
<p><strong>配置inception</strong></p>
<p>随便在哪个目录(建议就在编译目录)下新建 inc.cnf 文件，复制下面的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[inception]</div><div class="line">general_log=1</div><div class="line">general_log_file=inception.log</div><div class="line">port=6669</div><div class="line">socket=/自己目录，请自行修改/inc.socket</div><div class="line">character-set-client-handshake=0</div><div class="line">character-set-server=utf8</div><div class="line">inception_remote_system_password=root</div><div class="line">inception_remote_system_user=wzf1</div><div class="line">inception_remote_backup_port=3306</div><div class="line">inception_remote_backup_host=127.0.0.1</div><div class="line">inception_support_charset=utf8mb4</div><div class="line">inception_enable_nullable=0</div><div class="line">inception_check_primary_key=1</div><div class="line">inception_check_column_comment=1</div><div class="line">inception_check_table_comment=1</div><div class="line">inception_osc_min_table_size=1</div><div class="line">inception_osc_bin_dir=/data/temp</div><div class="line">inception_osc_chunk_time=0.1</div><div class="line">inception_enable_blob_type=1</div><div class="line">inception_check_column_default_value=1</div><div class="line">inception_check_autoincrement_name=0</div><div class="line">inception_enable_identifer_keyword=1</div><div class="line">inception_enable_sql_statistic=1</div></pre></td></tr></table></figure></p>
<p>参考以下更多的参数和选项：<br><a href="http://mysql-inception.github.io/inception-document/option/" target="_blank" rel="external">Inception使用规范及说明文档</a></p>
<p><strong>Inception启动</strong></p>
<p>和MySQL是一样的，Inception可执行文件可以在编译目录下面通过find命令找到，编译目录就是在执行inception_build.sh脚本时所在的目录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./debug/mysql/bin/Inception --defaults-file=inc.cnf</div></pre></td></tr></table></figure></p>
<p>注意： 因为Inception支持OSC执行的功能，是通过调用 pt-online-schema-change 工具来做的，但如果Inception后台启动（&amp;）的话，可能会导致 pt-online-schema-change 在执行完成之后，长时间不返回，进而导致Inception卡死的问题，这个问题后面会解决，但现阶段请尽量不要使用后台启动的方式，或者可以使用 nohup Inception 启动命令 &amp; 的方式来启动。</p>
<p>启动成功之后，可以简单试一下看，通过MySQL客户端<code>mysql -uroot -h127.0.0.1 -P6669</code>登录上去之后，再执行一个命令：<code>inception get variables</code>输出了所有的变量，恭喜你，已经启动成功了，都说了非常简单。</p>
<h4 id="Inception-web安装"><a href="#Inception-web安装" class="headerlink" title="Inception_web安装"></a>Inception_web安装</h4><p><strong>Python2.7下载及依赖安装</strong></p>
<p>这里需要安装Python2.7，CentOS自带的版本是2.6<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://www.python.org/ftp/python/2.7.8/Python-2.7.8.tgz</div><div class="line">tar xf Python-2.7.8.tgz</div><div class="line">cd Python-2.7.8</div><div class="line">./configure --prefix=/usr/local</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>安装成功之后，你可以在 <code>/usr/local/bin/python2.7</code> 找到 Python 2.7<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mv /usr/bin/python /usr/bin/python2.6</div><div class="line">ln -s /usr/local/bin/python2.7 /usr/bin/python</div><div class="line">vim  /usr/bin/yum</div></pre></td></tr></table></figure></p>
<p>将<code>#!/usr/bin/python</code>修改为：<code>#!/usr/bin/python2.6</code><br>安装<code>setuptools package</code>，方便自动升级。<br>通过引导程序 <code>ez_setup.py</code>来安装。这个引导程序会联网下载最新版本<code>setuptools</code>来安装，同时也可以更新本地的<code>setuptools</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget http://peak.telecommunity.com/dist/ez_setup.py</div><div class="line">sudo python ez_setup.py</div></pre></td></tr></table></figure></p>
<p>更新setuptools：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo python ez_setup.py -U setuptools</div><div class="line">easy_install-2.7 pip</div><div class="line">pip install flask-script</div><div class="line">pip install flask-debugtoolbar</div><div class="line">pip install flask_wtf</div><div class="line">pip install MySQL-python</div></pre></td></tr></table></figure></p>
<p><strong>安装</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/dbalihui/inception_web.git</div></pre></td></tr></table></figure></p>
<p>先将<code>app</code>目录中的<code>inception.py</code>文件里的账号密码改成自己的，记得<code>use sql_check</code>这里要改成自己的数据库名字<br>在<code>inception_web</code>目录下运行<code>./run.py runserver --host 0.0.0.0</code>，使用浏览器访问你的IP <a href="http://192.168.xx.xxx:5000/" target="_blank" rel="external">http://192.168.xx.xxx:5000/</a></p>
<p>配置文件信息如下：<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"></div><div class="line">import MySQLdb</div><div class="line"></div><div class="line">def table_structure(mysql_structure):</div><div class="line">    sql1=<span class="string">'/*--user=wwn;--password=123456;--host=192.168.x.xx;--execute=1;--port=3306;*/\</span></div><div class="line">            inception_magic_start;\</div><div class="line">            use wwn;'     //此处数据库是图形界面框中选择的数据，不然只写create table会报错提示要选择数据库。</div><div class="line">    sql2=<span class="string">'inception_magic_commit;'</span></div><div class="line">    sql = sql1 + mysql_structure + sql2</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        conn=MySQLdb.connect(host=<span class="string">'127.0.0.1'</span>,user=<span class="string">'wwn'</span>,passwd=<span class="string">'123456'</span>,db=<span class="string">'wwn'</span>,port=<span class="number">6669</span>,use_unicode=True, charset=<span class="string">"utf8"</span>)</div><div class="line">        cur=conn.cursor()</div><div class="line">        ret=cur.execute(sql)</div><div class="line">        result=cur.fetchall()</div><div class="line">        num_fields = len(cur.description) </div><div class="line">        field_names = [i[<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> cur.description]</div><div class="line">        print field_names</div><div class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> result:</div><div class="line">            print row[<span class="number">0</span>], <span class="string">"|"</span>,row[<span class="number">1</span>],<span class="string">"|"</span>,row[<span class="number">2</span>],<span class="string">"|"</span>,row[<span class="number">3</span>],<span class="string">"|"</span>,row[<span class="number">4</span>],<span class="string">"|"</span>,row[<span class="number">5</span>],<span class="string">"|"</span>,row[<span class="number">6</span>],<span class="string">"|"</span>,row[<span class="number">7</span>],<span class="string">"|"</span>,row[<span class="number">8</span>],<span class="string">"|"</span>,row[<span class="number">9</span>],<span class="string">"|"</span>,row[<span class="number">10</span>]</div><div class="line">        cur.close()</div><div class="line">        conn.close()</div><div class="line">    except MySQLdb.Error,e:</div><div class="line">        print <span class="string">"Mysql Error %d: %s"</span> % (e.args[<span class="number">0</span>], e.args[<span class="number">1</span>])</div><div class="line">    <span class="keyword">return</span> result[<span class="number">1</span>][<span class="number">4</span>].split(<span class="string">"\n"</span>)</div></pre></td></tr></table></figure></p>
<p>因为这个 web 界面的工具只是一个测试的 Demo 程序，很多深入的功能还需要自己开发。</p>
<h4 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h4><p><code>Supervisor</code>是一个<code>Python</code>开发的<code>client/server</code>系统，可以管理和监控<code>Linux</code>上面的进程。不过同<code>daemontools</code>一样，它也不能监控<code>daemon</code>进程</p>
<p><strong>部件</strong></p>
<p><code>Supervisor</code>有不同的部件组成，部件分别负责不同的功能，对进程进行监控和管理。</p>
<ul>
<li>supervisord<br>Supervisor的server部分称为supervisord。主要负责管理子进程，响应客户端的命令，log子进程的输出，创建和处理不同的事件</li>
<li>supervisorctl<br>Supervisor的命令行客户端。它可以与不同的supervisord进程进行通信，获取子进程信息，管理子进程</li>
<li>Web Server<br>Supervisor的web server，用户可以通过web对子进程进行监控，管理等等，作用与supervisorctl一致</li>
<li>XML-RPC interface<br>XML-RPC接口，提供XML-RPC服务来对子进程进行管理，监控</li>
</ul>
<p><strong>安装</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo pip install virtualenv</div><div class="line">mkdir /ht</div><div class="line">virtualenv-2.7 /ht</div><div class="line">source /ht/bin/activate</div><div class="line">deactivate</div><div class="line">sudo pip install supervisor</div></pre></td></tr></table></figure></p>
<p>安装完成之后，就可以用<code>echo_supervisord_conf</code>命令来生成配置文件，例如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</div></pre></td></tr></table></figure></p>
<p><strong>配置</strong></p>
<p>配置文件<code>supervisord.conf</code>是一个ini文件，可以对<code>http_server</code>、<code>supervisord</code>、<code>supervisorctl</code>和<code>program</code>进行配置。不过默认生成的文件已经对大部分进行配置，如果简单使用，只需要配置program的部分就可以了。<br>配置文件必须要有一个<code>program</code>配置项，这样supervisord才知道哪个program需要被管理和监控。<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">[supervisord]</div><div class="line">http_port=/var/tmp/supervisor.sock ; (default is to run a UNIX domain socket server)</div><div class="line">;http_port=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9001</span>  ; (alternately, ip_address:port specifies AF_INET)</div><div class="line">;sockchmod=<span class="number">0700</span>              ; AF_UNIX socketmode (AF_INET ignore, default <span class="number">0700</span>)</div><div class="line">;sockchown=nobody.nogroup     ; AF_UNIX socket uid.gid owner (AF_INET ignores)</div><div class="line">;umask=<span class="number">022</span>                   ; (<span class="keyword">process</span> file creation umask;default <span class="number">022</span>)</div><div class="line">logfile=/var/log/supervisor/supervisord.log ; (main log file;default <span class="variable">$CWD</span>/supervisord.log)</div><div class="line">logfile_maxbytes=<span class="number">50</span>MB       ; (max main logfile bytes b4 rotation;default <span class="number">50</span>MB)</div><div class="line">logfile_backups=<span class="number">10</span>          ; (num of main logfile rotation backups;default <span class="number">10</span>)</div><div class="line">loglevel=info               ; (logging level;default info; others: debug,warn)</div><div class="line">pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</div><div class="line">nodaemon=false              ; (start <span class="keyword">in</span> foreground <span class="keyword">if</span> true;default false)</div><div class="line">minfds=<span class="number">1024</span>                 ; (min. avail startup file descriptors;default <span class="number">1024</span>)</div><div class="line">minprocs=<span class="number">200</span>                ; (min. avail <span class="keyword">process</span> descriptors;default <span class="number">200</span>)</div><div class="line"></div><div class="line">;nocleanup=true              ; (don<span class="string">'t clean up tempfiles at start;default false)</span></div><div class="line">;http_username=user          ; (default is no username (open system))</div><div class="line">;http_password=123           ; (default is no password (open system))</div><div class="line">;childlogdir=/tmp            ; ('AUTO<span class="string">' child log dir, default $TEMP)</span></div><div class="line">;user=supervisor              ; (default is current user, required if root)</div><div class="line">;directory=/tmp              ; (default is not to cd during start)</div><div class="line">;environment=KEY=value       ; (key value pairs to add to environment)</div><div class="line"></div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///var/tmp/supervisor.sock ; use a unix:// URL  for a unix socket</div><div class="line">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket</div><div class="line">;username=chris              ; should be same as http_username if set</div><div class="line">;password=123                ; should be same as http_password if set</div><div class="line">;prompt=mysupervisor</div><div class="line"></div><div class="line">[group:pmaapp]</div><div class="line">programs=pma_web</div><div class="line"></div><div class="line">[program:pma_web]</div><div class="line">command=/opt/venv/pma_01/bin/python /opt/pma.git/run.py 807%(process_num)d</div><div class="line">process_name=%(program_name)s-807%(process_num)d ;这句不可缺少</div><div class="line">directory=/opt/pma.git</div><div class="line">autorestart=true</div><div class="line">user=www                 ; setuid to this UNIX account to run the program</div><div class="line">redirect_stderr=true</div><div class="line">stdout_logfile=/tmp/tornado-server-807%(process_num)d.log ;这个文件不能为空</div><div class="line">stdout_logfile_maxbytes=500MB</div><div class="line">stdout_logfile_backups=50</div><div class="line">stdout_capture_maxbytes=1MB</div><div class="line">stdout_events_enabled=false</div><div class="line">loglevel=warn</div><div class="line">numprocs=4 ;这里是启动的进程数</div><div class="line">numprocs_start=1</div></pre></td></tr></table></figure></p>
<p><strong>启动</strong></p>
<p>配置文件生成之后，就可以启动<code>supervisord</code>了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">supervisord     #默认使用/etc/supervisord.conf的配置文件</div><div class="line">supervisord -c /etc/supervisord.conf</div></pre></td></tr></table></figure></p>
<p>这里可能会有个报错：<br>Starting supervisor: Error: Another program is already listening on a port that one of our HTTP servers is configured to use.  Shut this program down first before starting supervisord.</p>
<p>解决方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find / -name supervisor.sock</div><div class="line">unlink /***/supervisor.sock</div></pre></td></tr></table></figure></p>
<p>当配置文件变化后，可以通过下面的命令<code>reload conf</code>，然后重启<code>supervisord</code>进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -HUP `cat /tmp/supervisord.pid`</div></pre></td></tr></table></figure></p>
<p><strong>通过supervisordctl管理进程</strong></p>
<p>然后通过<code>supervisorctl</code>就可以监控管理program了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ supervisorctl -c conf/app.conf  status</div><div class="line">node_app                         RUNNING    pid 6916, uptime 0:00:00</div><div class="line">tornado_app                      RUNNING    pid 6917, uptime 0:00:00</div><div class="line"></div><div class="line">$ supervisorctl -c conf/app.conf  stop node_app</div><div class="line">node_app: stopped</div><div class="line"></div><div class="line">$ supervisorctl -c conf/app.conf  stop tornado_app</div><div class="line">tornado_app: stopped</div><div class="line"></div><div class="line">$ supervisorctl -c conf/app.conf  status</div><div class="line">node_app                         STOPPED    Apr 04 02:34 AM</div><div class="line">tornado_app                      STOPPED    Apr 04 02:35 AM</div><div class="line"></div><div class="line">$ supervisorctl -c conf/app.conf  start all</div><div class="line">node_app: started</div><div class="line">tornado_app: started</div><div class="line"></div><div class="line">$ supervisorctl -c conf/app.conf  status</div><div class="line">node_app                         RUNNING    pid 8080, uptime 0:00:00</div><div class="line">tornado_app                      RUNNING    pid 8079, uptime 0:00:00</div></pre></td></tr></table></figure></p>
<p><strong>通过web管理进程</strong></p>
<p>如果配置文件开启<code>http server</code>，那么就可以通过web界面来管理program了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ grep -A 3 &quot;inet_http_server&quot; conf/app.conf </div><div class="line">[inet_http_server]         ; inet (TCP) server disabled by default</div><div class="line">port=0.0.0.0:8383        ; (ip_address:port specifier, *:port for all iface)</div><div class="line">#username=user              ; (default is no username (open server))</div><div class="line">#password=123               ; (default is no password (open server))</div></pre></td></tr></table></figure></p>
<p>然后打开 <a href="http://domain.com:8383" target="_blank" rel="external">http://domain.com:8383</a> 就可以访问了</p>
<p><strong>问题</strong><br>通过<code>supervisord</code>可以很方便的管理<code>program</code>，可以同时管理多个<code>program</code>，也可以管理一个<code>program</code>的多个进程。而且提供了命令行、<code>web</code>、<code>xml-rpc</code>的接口来管理和监控进程，通过配置文件，可以指定进程挂掉后如何处理(可以重启或者其它方式处理挂掉的进程)</p>
<p>但是，<code>supervisord</code>本身也是一个<code>program</code>，如果它自己挂掉了怎么办?</p>
<p>解决方法：<br>如果<code>supervisord</code>挂了，请参考：<br><a href="http://serverfault.com/questions/96499/how-to-automatically-start-supervisord-on-linux-ubuntu" target="_blank" rel="external">在ubuntu上如何自动启动supervisord</a><br>使用<code>upstart</code>把<code>supervisor</code>封装成系统进程</p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a href="http://blog.tanchao.org/2016/01/05/mysql-inception-web/" target="_blank" rel="external">OutMan の Blog</a></p>
<p><a href="https://github.com/dbalihui/inception_web" target="_blank" rel="external">Inception-web源码和文档</a></p>
<p><a href="http://mysql-inception.github.io/inception-document/chapter1/" target="_blank" rel="external">Inception使用规范及说明文档</a></p>
<p><a href="http://linbo.github.io/2013/04/04/supervisor/" target="_blank" rel="external">进程的守护神 - Supervisor</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/29/change master/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WARREN's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/29/change master/" itemprop="url">正常切主库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-29T10:08:16+08:00">
                2016-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/M-S/" itemprop="url" rel="index">
                    <span itemprop="name">M/S</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>数据库架构</strong></p>
<p><img src="/images/1461918448281.png" alt="Alt text"></p>
<p><strong>技术层面的步骤：</strong></p>
<p>1.确认<code>old master</code>没有数据在插入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show processlist;</div></pre></td></tr></table></figure></p>
<p>2.确认<code>new master</code>和统计库没有SQL同步过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">show processlist;</div><div class="line">show slave status\G</div></pre></td></tr></table></figure></p>
<p>3.将<code>old master</code>设置成只读，防止切换的过程中有数据插入导致数据丢失<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">set global read_only = on;</div><div class="line">flush tables with read lock;</div></pre></td></tr></table></figure></p>
<p>4.再次确认新老<code>master</code>和统计库的状态不变（同1、2步），然后停掉统计库和<code>new master</code>的slave</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stop slave;</div><div class="line">reset slave all;</div></pre></td></tr></table></figure>
<p>5.把<code>new master</code>变成统计库的新主库，授权并查看binlog文件和位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">grant replication slave, replication client on *.* to repl@&apos;xxx&apos; identified by &apos;repl&apos;;</div><div class="line">flush privileges;</div><div class="line">show master status\G</div></pre></td></tr></table></figure></p>
<p>6.进统计库指向<code>new master</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">change master to master_host=&apos;192.168.xx.xxx&apos;, MASTER_PORT=3306, master_user=&apos;repl&apos;, master_password=&apos;repl&apos;, master_log_file=&apos;mysql-bin.000006&apos;, master_log_pos=245;</div><div class="line">start slave;</div><div class="line">show slave status\G</div></pre></td></tr></table></figure></p>
<p>7.进<code>old master</code>指向<code>new master</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">change master to master_host=&apos;192.168.xx.xxx&apos;, MASTER_PORT=3306, master_user=&apos;repl&apos;, master_password=&apos;repl&apos;, master_log_file=&apos;mysql-bin.000006&apos;, master_log_pos=245;</div><div class="line">start slave;</div><div class="line">show slave status\G</div><div class="line">unlock tables;</div></pre></td></tr></table></figure></p>
<p>8.设定<code>new master</code>的<code>read_only=OFF</code>，保证新主库可写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set global read_only = off;</div></pre></td></tr></table></figure></p>
<p>9.调整<code>HAproxy</code>配置，改变写入目的到<code>new master</code></p>
<p>10.进行测试</p>
<p><strong>流程方面的步骤：</strong></p>
<p>1.通知开发同学们我们做这个事情了。</p>
<p>2.做的过程中每个步骤需要第二名同事进行double check。</p>
<p>3.对new master进行测试，一定要测的就是路由。</p>
<p>4.检查授权是否new master和old master一致。</p>
<p>5.检查参数是否new master和old master一致。</p>
<p>6.修改写入目的之前通知大家一声。</p>
<p>7.修改写入目的之后联系业务同学check一下业务。</p>
<p>8.发个完成通知告诉大家可以洗洗睡了。</p>
<p>从上面我们可以看出，其实流程方面就2个事情“check”和“通知”，仅此而已。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/20/mysql-performance-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WARREN's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/20/mysql-performance-test/" itemprop="url">MySQL性能测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-20T10:08:16+08:00">
                2016-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/mysqlslap/" itemprop="url" rel="index">
                    <span itemprop="name">mysqlslap</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/mysqlslap/sysbench/" itemprop="url" rel="index">
                    <span itemprop="name">sysbench</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>操作系统 ：</strong>Centos 6.4 64位<br><strong>软件版本 ：</strong>10.0.24-MariaDB</p>
<p>本次测试只是<code>MySQL</code>初学者的一次操作练习，并没有按照专业的测试方法来操作，不专业和错误的地方还希望大家看了之后能够指出来，我好及时改正。</p>
<h4 id="总则："><a href="#总则：" class="headerlink" title="总则："></a>总则：</h4><p>用你想象得到的方法测试<code>MySQL</code>的性能，并且用<code>Zabbix</code>监控观察和记录所用测试方法对性能的影响。</p>
<h4 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h4><h4 id="1-MySQL基本性能测试："><a href="#1-MySQL基本性能测试：" class="headerlink" title="1. MySQL基本性能测试："></a><strong>1. MySQL基本性能测试：</strong></h4><p>测试内容：</p>
<p>至少用到两个MySQL性能测试工具，记录关键性能指标，此处可以有个表格来记录。</p>
<p><code>mysqlslap</code>测试方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlslap -a --auto-generate-sql-load-type=mixed --concurrency=50,100 --number-of-queries 500 --iterations=5 --engine=innodb --debug-info -uroot -p</div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">   Benchmark</div><div class="line">Running for engine innodb</div><div class="line">Average number of seconds to run all queries: 0.470 seconds</div><div class="line">Minimum number of seconds to run all queries: 0.379 seconds</div><div class="line">Maximum number of seconds to run all queries: 0.558 seconds</div><div class="line">Number of clients running queries: 50</div><div class="line">Average number of queries per client: 10</div><div class="line"></div><div class="line">Benchmark</div><div class="line">Running for engine innodb</div><div class="line">Average number of seconds to run all queries: 0.515 seconds</div><div class="line">Minimum number of seconds to run all queries: 0.400 seconds</div><div class="line">Maximum number of seconds to run all queries: 0.656 seconds</div><div class="line">Number of clients running queries: 100</div><div class="line">Average number of queries per client: 5</div><div class="line"></div><div class="line"></div><div class="line">User time 0.27, System time 0.52</div><div class="line">Maximum resident set size 9440, Integral resident set size 0</div><div class="line">Non-physical pagefaults 11044, Physical pagefaults 12, Swaps 0</div><div class="line">Blocks in 2536 out 0, Messages in 0 out 0, Signals 0</div><div class="line">Voluntary context switches 16104, Involuntary context switches 99</div></pre></td></tr></table></figure>
<p><code>sysbench</code>测试方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysbench --test=oltp --mysql-table-engine=innodb --mysql-user=root --db-driver=mysql --mysql-db=test  --oltp-table-size=30000 --oltp-table-name=t1 --oltp-nontrx-mode=insert --mysql-socket=/var/lib/mysql/mysql.sock --mysql-password=xxxxx run</div></pre></td></tr></table></figure>
<p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">   OLTP test statistics:</div><div class="line">   queries performed:</div><div class="line">       read:                            140000</div><div class="line">       write:                           50000</div><div class="line">       other:                           20000</div><div class="line">       total:                           210000</div><div class="line">   transactions:                        10000  (49.42 per sec.)</div><div class="line">   deadlocks:                           0      (0.00 per sec.)</div><div class="line">   read/write requests:                 190000 (938.97 per sec.)</div><div class="line">   other operations:                    20000  (98.84 per sec.)</div><div class="line"></div><div class="line">Test execution summary:</div><div class="line">    total time:                          202.3498s</div><div class="line">    total number of events:              10000</div><div class="line">    total time taken by event execution: 202.2598</div><div class="line">    per-request statistics:</div><div class="line">         min:                                  9.18ms</div><div class="line">         avg:                                 20.23ms</div><div class="line">         max:                               1087.05ms</div><div class="line">         approx.  95 percentile:              38.61ms</div><div class="line"></div><div class="line">Threads fairness:</div><div class="line">    events (avg/stddev):           10000.0000/0.00</div><div class="line">    execution time (avg/stddev):   202.2598/0.00</div></pre></td></tr></table></figure></p>
<p>关键性能指标变化情况：</p>
<table>
<thead>
<tr>
<th style="text-align:center">关键参数意义</th>
<th style="text-align:center">关键参数值</th>
<th style="text-align:center">mysqlslap</th>
<th style="text-align:center">sysbench</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MYSQL 从缓冲池中读取页次数</td>
<td style="text-align:center">Innodb_buffer_pool_read_requests</td>
<td style="text-align:center">91.1M-92M</td>
<td style="text-align:center">92.5M-111M</td>
</tr>
<tr>
<td style="text-align:center">MYSQL 从物理磁盘读取页次数</td>
<td style="text-align:center">Innodb_buffer_pool_reads</td>
<td style="text-align:center">x</td>
<td style="text-align:center">0-35K</td>
</tr>
<tr>
<td style="text-align:center">MYSQL 线程连接</td>
<td style="text-align:center">Threads_connected</td>
<td style="text-align:center">x</td>
<td style="text-align:center">1.0-2.0</td>
</tr>
<tr>
<td style="text-align:center">MYSQL 当前激活线程数</td>
<td style="text-align:center">Threads_running</td>
<td style="text-align:center">x</td>
<td style="text-align:center">1.0-2.0</td>
</tr>
<tr>
<td style="text-align:center">每秒Query量</td>
<td style="text-align:center">QPS</td>
<td style="text-align:center">0-110</td>
<td style="text-align:center">0-0.9K</td>
</tr>
<tr>
<td style="text-align:center">每秒事务量</td>
<td style="text-align:center">TPS</td>
<td style="text-align:center">x</td>
<td style="text-align:center">0-43</td>
</tr>
</tbody>
</table>
<h4 id="2-MySQL业务使用场景测试（M-S环境下测试）："><a href="#2-MySQL业务使用场景测试（M-S环境下测试）：" class="headerlink" title="2. MySQL业务使用场景测试（M/S环境下测试）："></a><strong>2. MySQL业务使用场景测试（M/S环境下测试）：</strong></h4><p>测试内容：</p>
<p><strong>0.插入制造大量的测试数据（记录500W行以上，空间1G以上，至少有一个这样的大表）</strong></p>
<p>表结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">   create_tablea_sql=&quot;create table IF NOT EXISTS $&#123;TABLENAME&#125;(</div><div class="line">id int(5) primary key,</div><div class="line">name varchar(20),</div><div class="line">createtime datetime,</div><div class="line">age int(10),</div><div class="line">introduction char(200)</div><div class="line">)</div><div class="line">ENGINE=$&#123;ENGINE&#125; </div><div class="line">DEFAULT CHARSET=utf8&quot;</div><div class="line"></div><div class="line">create_tableb_sql=&quot;create table IF NOT EXISTS test_table_b(</div><div class="line">id int(5) primary key NOT NULL AUTO_INCREMENT,</div><div class="line">name varchar(20),</div><div class="line">createtime datetime,</div><div class="line">age int(10),</div><div class="line">introduction char(200)</div><div class="line">)</div><div class="line">ENGINE=$&#123;ENGINE&#125;</div><div class="line">DEFAULT CHARSET=utf8&quot;</div></pre></td></tr></table></figure></p>
<p>插入数据后大表大小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">+--------------+---------------+---------+------------------+</div><div class="line">| TABLE_NAME   | DB_NAME       | ROWS    | PHYSICAL_SIZE_MB |</div><div class="line">+--------------+---------------+---------+------------------+</div><div class="line">| test_table_b | test_20160421 | 5839363 |    2199.69595432 |</div><div class="line">+--------------+---------------+---------+------------------+</div></pre></td></tr></table></figure>
<p>插入数据后小表大小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">+--------------+---------------+-------+------------------+</div><div class="line">| TABLE_NAME   | DB_NAME       | ROWS  | PHYSICAL_SIZE_MB |</div><div class="line">+--------------+---------------+-------+------------------+</div><div class="line">| test_table_a | test_20160421 | 19575 |       7.50460625 |</div><div class="line">+--------------+---------------+-------+------------------+</div></pre></td></tr></table></figure>
<p>插入测试数据过程中各参数变化情况：</p>
<p><strong>主库</strong></p>
<p><code>CPU load</code><br><img src="/images/CPU iowait time.png" alt="Alt text"></p>
<p><code>CPU iowait time</code><br><img src="/images/CPU iowait time.png" alt="Alt text"></p>
<p><code>Innodb_buffer_pool_read_requests</code><br><img src="/images/Innodb_buffer_pool_read_requests.png" alt="Alt text"></p>
<p><code>Innodb_buffer_pool_reads</code><br><img src="/images/Innodb_buffer_pool_reads.png" alt="Alt text"></p>
<p><code>QPS</code><br><img src="/images/QPS.png" alt="Alt text"></p>
<p><code>Threads_connected</code><br><img src="/images/Threads_connected.png" alt="Alt text"></p>
<p><code>Threads_running</code><br><img src="/images/Threads_running.png" alt="Alt text"></p>
<p><strong>从库</strong></p>
<p><code>CPU load</code><br><img src="/images/CPU load2.png" alt="Alt text"></p>
<p><code>CPU iowait time</code><br><img src="/images/IOwait.png" alt="Alt text"></p>
<p><code>Innodb_buffer_pool_read_requests</code><br><img src="/images/MYSQL 从缓冲池中读取页次数.png" alt="Alt text"></p>
<p><code>QPS</code><br><img src="/images/QPS2.png" alt="Alt text"></p>
<p><code>TPS</code><br><img src="/images/TPS2.png" alt="Alt text"></p>
<p><strong>1、添加索引（一句添加一个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE `test_table_b` ADD INDEX(createtime);</div><div class="line"># 测试结果</div><div class="line">Query OK, 0 rows affected (5 min 19.05 sec)         </div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><code>iowait</code></p>
<p><img src="/images/1461219108244.png" alt="Alt text"></p>
<p>大概7分钟左右。</p>
<p><strong>2、添加索引（多句修改多个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE `test_table_b` ADD INDEX(createtime);</div><div class="line">ALTER TABLE `test_table_b` ADD INDEX(name);</div><div class="line">ALTER TABLE `test_table_b` ADD INDEX(age);</div><div class="line"># 测试结果</div><div class="line">Query OK, 0 rows affected (5 min 17.07 sec)         </div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line">Query OK, 0 rows affected (5 min 51.08 sec)         </div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line">Query OK, 0 rows affected (5 min 39.38 sec)         </div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><code>iowait</code></p>
<p><img src="/images/1461222070278.png" alt="Alt text"></p>
<p>大概19分钟左右。</p>
<p><strong>3、添加索引（一句修改多个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE `test_table_b` ADD INDEX(createtime),ADD INDEX(name),ADD INDEX(age);</div><div class="line"># 测试结果</div><div class="line">Query OK, 0 rows affected (7 min 55.30 sec)         </div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><code>iowait</code></p>
<p><img src="/images/1461220178411.png" alt="Alt text"></p>
<p><strong>4、添加索引（OSC变更）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">pt-online-schema-change --user=root --password=warren --host=127.0.0.1  --alter &quot;ADD INDEX idx_name(name)&quot; D=test_20160421,t=test_table_b --no-check-alter --no-check-replication-filters --recursion-method=none --print --execute</div><div class="line"># 测试结果</div><div class="line">2016-04-21T15:01:55 Created triggers OK.</div><div class="line">2016-04-21T15:01:55 Copying approximately 5839363 rows...</div><div class="line">2016-04-21T16:07:28 Copied rows OK.</div><div class="line">2016-04-21T16:07:28 Analyzing new table...</div><div class="line">2016-04-21T16:07:33 Swapping tables...</div><div class="line">RENAME TABLE `test_20160421`.`test_table_b` TO `test_20160421`.`_test_table_b_old`, `test_20160421`.`_test_table_b_new` TO `test_20160421`.`test_table_b`</div><div class="line">2016-04-21T16:07:37 Swapped original and new tables OK.</div><div class="line">2016-04-21T16:07:37 Dropping old table...</div><div class="line">DROP TABLE IF EXISTS `test_20160421`.`_test_table_b_old`</div><div class="line">2016-04-21T16:07:40 Dropped old table `test_20160421`.`_test_table_b_old` OK.</div><div class="line">2016-04-21T16:07:40 Dropping triggers...</div></pre></td></tr></table></figure>
<p>大约用时：1小时6分钟 </p>
<p><strong>从库：</strong></p>
<p><code>TPS</code></p>
<p><img src="/images/1461226653253.png" alt="Alt text"></p>
<p>大约用时：1小时6分钟</p>
<p><strong>5、删除索引（一句添加一个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DROP INDEX createtime ON test_table_b;</div><div class="line"># 测试结果</div><div class="line">Query OK, 0 rows affected (0.10 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><code>iowait</code></p>
<p>大约0.1秒</p>
<p><strong>6、删除索引（多句修改多个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE `test_table_b` DROP INDEX createtime;</div><div class="line">ALTER TABLE `test_table_b` DROP INDEX name;</div><div class="line">ALTER TABLE `test_table_b` DROP INDEX age;</div><div class="line"># 测试结果</div><div class="line">Query OK, 0 rows affected (0.69 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line">Query OK, 0 rows affected (3.00 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line">Query OK, 0 rows affected (0.12 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p>大约3.81秒</p>
<p><strong>7、删除索引（一句修改多个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE `test_table_b` DROP INDEX createtime,DROP INDEX name,DROP INDEX age;</div><div class="line"># 测试结果</div><div class="line">Query OK, 0 rows affected (0.31 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p>大约0.31秒</p>
<p><strong>8、删除索引（OSC变更）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pt-online-schema-change --user=root --password=warren --host=127.0.0.1 --alter &quot;DROP INDEX idx_name&quot; D=test_20160421,t=test_table_b --no-check-alter --no-check-replication-filters --recursion-method=none --print --execute</div><div class="line"># 测试结果</div><div class="line">2016-04-21T20:06:15 Creating triggers...</div><div class="line">2016-04-21T20:17:42 Dropped triggers OK.</div><div class="line">2016-04-21T20:17:42 Dropping new table...</div></pre></td></tr></table></figure>
<p>使用时间：11分钟27秒=687秒</p>
<p><strong>从库：</strong></p>
<p>无法取得准确数据</p>
<p><strong>9、update大量数据(用主键)</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 查询数据条数</div><div class="line">select count(*) from test_table_b where id&gt;2000 and id&lt;3000000; </div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|  1836202 |</div><div class="line">+----------+</div><div class="line">1 row in set (26.55 sec)</div><div class="line"></div><div class="line"># 更新数据</div><div class="line">update test_table_b set age=50 where id&gt;2000 and id&lt;3000000; </div><div class="line"># 测试结果</div><div class="line">Query OK, 1836202 rows affected (3 min 45.09 sec)</div><div class="line">Rows matched: 1836202  Changed: 1836202  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p>无法取得准确数据</p>
<p><strong>10、update大量数据(非主键 非索引)</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 查询数据条数</div><div class="line">select count(*) from test_table_b where createtime&lt;&quot;2016-04-21 10:35:23&quot; and createtime&gt;&quot;2016-04-21 10:20:23&quot;; </div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|  4080752 |</div><div class="line">+----------+</div><div class="line">1 row in set (4 min 27.36 sec)</div><div class="line"></div><div class="line"># 更新数据</div><div class="line">update test_table_b set age=30 where createtime&lt;&quot;2016-04-21 10:35:23&quot; and createtime&gt;&quot;2016-04-21 10:20:23&quot;; </div><div class="line"># 测试结果</div><div class="line">Query OK, 4080752 rows affected (5 min 38.14 sec)</div><div class="line">Rows matched: 4080752  Changed: 4080752  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><code>iowait</code></p>
<p><img src="/images/1461227721260.png" alt="Alt text"></p>
<p>大约7分钟</p>
<p><strong>11、update大量数据(非主键 有索引)</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 查询数据条数</div><div class="line">select count(*) from test_table_b where name&lt;&quot;用户20000&quot; and createtime&gt;&quot;用户2000&quot;; </div><div class="line">+----------+</div><div class="line">| count(*) |</div><div class="line">+----------+</div><div class="line">|  2029612 |</div><div class="line">+----------+</div><div class="line">1 row in set, 1 warning (1 min 45.53 sec)</div><div class="line"></div><div class="line"># 更新数据</div><div class="line">update test_table_b set age=40 where name&lt;&quot;用户20000&quot; and createtime&gt;&quot;用户2000&quot;;</div><div class="line"># 测试结果</div><div class="line">Query OK, 2029612 rows affected, 1 warning (6 min 27.09 sec)</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><code>iowait</code></p>
<p>无法取得准确数据</p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select * from test_table_b left join test_table_a on test_table_b.id=test_table_a.id where test_table_b.id &lt; 50000;</div><div class="line"># 测试结果</div><div class="line">37232 rows in set (1.02 sec)</div></pre></td></tr></table></figure>
<p><strong>12、排序查询</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select * from test_table_b where id &lt; 2000000 order by createtime DESC;</div><div class="line"># 测试结果</div></pre></td></tr></table></figure>
<p><strong>13、修改表结构（一句修改一个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">alter table test_table_b modify name varchar(70);</div><div class="line"># 测试结果</div><div class="line">Query OK, 5980000 rows affected (22 min 51.15 sec)     </div><div class="line">Records: 5980000  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong><br><code>IOwait</code></p>
<p><img src="/images/1461234760212.png" alt="Alt text"></p>
<p><strong>14、修改表结构（多句修改多个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">alter table test_table_b modify name varchar(30);</div><div class="line">alter table test_table_b drop column test;</div><div class="line">alter table test_table_b add test2 int(20);</div><div class="line"># 测试结果&amp;</div><div class="line">Query OK, 6360000 rows affected (39 min 43.42 sec)     </div><div class="line">Records: 6360000  Duplicates: 0  Warnings: 0</div><div class="line">Query OK, 6360000 rows affected (36 min 36.42 sec)     </div><div class="line">Records: 6360000  Duplicates: 0  Warnings: 0</div><div class="line">Query OK, 6360000 rows affected (37 min 21.26 sec)     </div><div class="line">Records: 6360000  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p>无法取得准确数据</p>
<p><strong>15、修改表结构（一句修改多个）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">alter table test_table_b modify name varchar(50),add test int(20),modify age int(20);</div><div class="line"># 测试数据</div><div class="line">Query OK, 6020000 rows affected (43 min 27.49 sec)     </div><div class="line">Records: 6020000  Duplicates: 0  Warnings: 0</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p><img src="/images/1461239357277.png" alt="Alt text"></p>
<p><strong>16、修改表结构（OSC变更）</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pt-online-schema-change --user=root --password=warren --host=127.0.0.1  --alter &quot;CHANGE COLUMN age AGE int(30)&quot; D=test_20160421,t=test_table_b --no-check-alter --no-check-replication-filters --recursion-method=none --quiet --execut</div><div class="line"></div><div class="line"># 测试结果</div><div class="line">出现异常报错</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p>无法获取数据</p>
<p><strong>17、detele大量数据(用主键)</strong></p>
<p><strong>主库：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">delete from test_table_a where id &lt; 3054793</div></pre></td></tr></table></figure>
<p><strong>从库：</strong></p>
<p>无法获取数据</p>
<h4 id="数据汇总"><a href="#数据汇总" class="headerlink" title="数据汇总"></a>数据汇总</h4><p>（以下数据可能存在很多错误）</p>
<p><strong>主库测试数据：</strong></p>
<p><img src="/images/1461242852929.png" alt="Alt text"></p>
<p><strong>从库测试数据：</strong></p>
<p>（由于能力的问题，不能很好的取到Slave同步所用的时间）</p>
<p><img src="/images/1461242906692.png" alt="Alt text"></p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a><strong>总结：</strong></h4><p><strong>1)</strong>测试过程中基本上都会收到<code>Disk I/O is overloaded</code>的报警信息，而且对数据量大的表进行DML和DDL操作时间都会比较长，可见MySQL要是直接裸跑而不采用任何缓存大法机制的话，性能一般都是非常差的。<br><strong>2)</strong>知道用<code>mysqlslap</code>和<code>sysbench</code>两种性能测试工具对MySQL进行测试，并且知道两种工具的区别，<code>mysqlslap</code>可以自动清理生成的数据表和工具，还能进行多线程的测试，<code>sysbench</code>功能更加强大，想测试CPU和内存什么的都可以。<br><strong>3)</strong>percona-toolkit之<code>pt-online-schema-change</code>（在线更改表结构）<br>优点：<br>能在不锁表的情况下安全快速地更新表结构。<br>缺点：<br>①如果修改的表没有主键，则会报错<br>②该操作会创建临时表，如果存在主从复制，而且设定的主从复制表，那么会导致从库同步失败，原因是没有同步临时表<br>③如果字段为<code>not null</code>，但没给<code>default</code>值，也会报错<br>④该工具不是mysql官方工具，所以操作时建议备份，避免意外</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/15/say goodbye to tuoyan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WARREN's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/15/say goodbye to tuoyan/" itemprop="url">和拖延说拜拜</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-15T13:27:30+08:00">
                2016-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/拖延/" itemprop="url" rel="index">
                    <span itemprop="name">拖延</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近因为实习的关系发现自己有一定程度的拖延症，还对自己的个人发展产生了一定的困扰。其实很早以前就知道自己拖延，但是因为对生活没什么特别大的影响，所以就一直忽略这个问题。正好想起之前看到过有对拖延进行分析和如何改进的文章，现在分享出来给大家看看，并以此激励自己不断进步。</p>
<p>每个人或多或少都会拖延，认识到自己有拖延，而且积极应对的人，都是对生活较为认真的人。<strong>当我意识到自己的拖延问题之后，我开始来正视它</strong>。我认真读了《<strong>拖延心理学</strong>》和《<strong>战胜拖延症</strong>》两本书，做了较多的笔记，也按照书上说的，分析自己、找原因、找解决办法。</p>
<p>几年过去了，在对付拖延上有了一点进步，自己的一些心得如下</p>
<p>我很清楚拖延带来的危害；<br>在某件事情上拖延了，我能感知到；<br>发生拖延时，能分析出导致拖延的因素，最后找到解决办法。</p>
<p>拖延是一种明知道会影响自己做事的效果或自身做事的态度，却依然自愿推迟既定事项的行为。工作的拖延不仅仅给自己带来烦恼，也会给同事带来烦恼，谁也不愿意和经常拖延的人合作。拖延给我们带来了内在和外在的危害，内在危害有焦虑、自我谴责、后悔、自卑、绝望及损害身体健康；外在危害包括失去上级或同事的信任、浪费机会以及绩效不好。</p>
<p>1997 年，美国 Case Western Reserve University 的两位研究者做了一个心理学测试。开学时，用一般拖延量表测量一个班同学的拖延情况，按照量表情况，把学生分为拖沓者和不拖沓者，然后在学堂上布置了一篇期末论文。在学期初和学期末，学生们还要求报告他们体验到了多少次身体不适的症状。结果不出所料，<strong>拖沓者交论文的时间平均晚于不拖沓者，而且得分也普遍偏低</strong>。在身体不适上，学期初，拖沓者报告的症状更少，但在学期末，他们所报告的症状明显多于不拖沓者，这证明了拖延会带来身体健康的损害。这些拖延带来的危害，也是告知我们正在拖延的信号。</p>
<p>从 2015 年年底开始，我在做一个个人网站，刚开始劲头很大，每天晚上都能抽出 1 个小时来写代码。但过年了，这个事情就停滞了。停滞确实有(在)原(拖)因(延)，备案正在申请中，等下来再说，而且大过年的，休息休息。又或者觉得有其他杂事比较忙，等忙完这些再说。但是在另外一方面，我内心又感觉到焦虑，总觉得事情悬在那里不是办法，但每次都没有下决心去解决。<strong>当我完全感受到这种状态时，立马强迫自己行动</strong>，但还是浪费了将近 20 天的时间，原来的计划也被打乱，网站正式发布就又延迟了。</p>
<p>关于拖延给我们的另一种信号，一个朋友分享了他的一个故事。公司有一关键系统运行正常，就是占用服务器较多，公司交给他来重构。经过三个多月开发，重构代码已经完成，也开始灰度上线了。公司层面觉得应该再过两月就差不多了，两个月过去了，系统还在继续灰度。上司找他谈，希望能快点全量，<strong>这是拖延给他的信号</strong>，他忽略了，认为这么大的系统重构，稍微延后一点也正常；又过去一个月，还在灰度中，上司找他谈，语气就比较重了，这是拖延的第二次信号，他也忽略了，同时还觉得委屈，自己每天忙活这个事情，却得不到理解。朋友后来和我分析了一下当时的心理状态，由于在灰度过程中，重构系统始终达不到较好的状态，出了一些小问题。但考虑到系统很关键，朋友非常担心一旦全量上线，出现问题会兜不住，作为一定程度完美主义的性格，在没达到自己期望效果时迟迟不敢决定，所以不自觉地把项目拖延了。朋友在这家公司的表现成绩最终让自己也不满意，只好辞职走了。</p>
<p>大部分人也碰到过，在写一个分享 PPT 时，快要到演讲日期了，PPT 还没有写。每次总想找一个大段空闲的时间来完成，等真找到时间了，坐下来开始写，却又无从着手，找不着感觉。这时最想做的是起身去做其他事情，逃离。一旦有这种信号，就变成了拖延中套着拖延，此时也只有<strong>命令自己一定要坐下来，哪怕干坐着，也要坐着，不看手机，不上网，开始写</strong>。</p>
<p>我们知道拖延的危害，当出现拖延情况时，我们可以通过自己的观察、上司及同事反馈等渠道，收集到各种各样的拖延信号。这时我们最需要做的就是<strong>确认自己处于拖延状况，然后分析拖延的因素，尽快找到解决办法</strong>。</p>
<p>在互联网公司从业的朋友，很容易看到互联网大佬们各种布局，指点江山来改变整个行业。因此很容易庆幸自己找对行业，并暗暗设定目标，30 岁之前要自己当老板。但很快 30 岁就到了，发现还是没有当成老板。目标有了，但对自己达成目标缺乏自信，也不知道如何入手。</p>
<p>很多人很多时候知道自己的目标，但是不知道如何从现在的点走到那个目标。这种情况<strong>把目标细分成几个易达成的小目标更合适</strong>。如毕业一年后，能有自己的 APP 或网站；两年后，业务能有一定的收入（比如占自己收入比的 10%），这样一步一步，后续也许真的就成了。有认识做自媒体做得不错的，确实就是从博客时代一直跟进，一周两篇文章，从不间断，慢慢地这件事情就做成了。这就是目标分解的力量。</p>
<p>工作中，如果项目规划周期过长，如超过半年，就容易出现前面松懈拖延，后面努力追赶进度的情况，不少人的心态是，时间还很多，前松后紧，但一般最后的结果是项目延期。</p>
<p>目标和回报太遥远，会导致我们拖延。要解决这个问题，是<strong>任务分解，同时每完成其中一个子任务，就奖赏一下自己</strong>。敏捷开发中讲究的持续迭代，就是让开发人员看到每一次迭代的效果，能感受到任务完成的成就感。阶段任务完成后，哪怕是一点点零食的奖赏，都能给我们带来一种满足感。我们的心里也许就是在海洋馆表演的海豹，表现好就是为了得到一条鱼。慢慢地形成一个正反馈后，也就养成了做事不拖延的习惯。</p>
<p>2007 年买了第一步智能手机，诺基亚的 E50，能安装 App，当时觉得很了不起，终于可以随意看小说了。大概花了一个月的时间在看《大唐双龙传》，再到后面的玄幻小说，感觉那时自己魔怔了，坐公交，吃饭，上班间歇，睡觉前都在看，心里只想继续读下去。回过头去看，当时不分日夜玩手机确实严重影响了正常的工作与生活，造成了正常任务的拖延。</p>
<p>现在智能机人手一部，有各种主动看的信息，如朋友圈、微博、微信公众号、新闻、电影电视剧及直播等；也有各种被动信息，各个 App 不停地推送各种信息。我们不自觉就手机上瘾了，走路、吃饭、睡觉都要看手机，一些人洗手洗脸的时候，也要单手看手机。</p>
<p>后果就是，我们无法约束自己，容易冲动和分心，工作一会会，就要翻一下手机。而对大部分人来说，同时只能做一件事情，否则就像进程切换一样，我们从手机及工作之间来回切换，非常浪费时间和精力。为解决自己的手机上瘾问题，我给自己定的规矩是：微信群基本设为接收不提醒；工作时不参加无关群聊；少看或不看小说，电视剧；工作时把手机放远点，屏幕朝桌子下方；上厕所时不要看手机。我建议每个人每天也都设定一个时间段不用手机。</p>
<p>拖延存在一个怪圈：这次要早点开始-&gt;得马上开始-&gt;不开始又怎样-&gt;干点别的吧-&gt;我有毛病-&gt;最后的抉择(事情做还是不做)-&gt;下次不再拖延-&gt;这次要早点开始-&gt;…，周而复始。当拖延发生时，我们总希望通过逃避，屈从于各种悠闲的活动，最后受伤的总是自己。What doesn’t kill you make you stronger，有一定道理，但是拖延造成的伤痕已经存在，拖延导致的精神赘肉也慢慢变多，我还是那个我，我已经不是那个我了。<br><img src="/images/拖延怪圈.jpg" alt="Alt text"></p>
<p>2013 年新浪创新大赛，我们组了一个队大概 5 个人，作品是直播地球，就是当前火爆的手机直播，名字有点土，但那时还比较前卫。因为没有经验，我们卡壳在产品设计，Android 开发上，士气低落，大家基本认定这个事情没什么好结果，部门 leader 也会失望。最后也确实令人失望：只写了 PPT，没有产品原型，没有 APP。</p>
<p>如果我们对任务反感或恐惧，认定有重重困难，结局会很惨，出于人的自我保护本能，自觉不自觉我们都会拖延。这时我们需要的是<strong>了解自己真正反感和恐惧的是什么，然后根据这个找到解决办法</strong>。创新大赛我们团队五个人都是服务端工程师，没有产品设计经验，没有 app 开发经验，较短的时间既要设计出像样的产品，还要开发出 app，这才是我们恐惧的原因。如当时能够调整团队结构，把自己不擅长的事情交由擅长的人来做，事情就能好很多，至少能有一个像样的结果出来。</p>
<p>自我改变是我每天的旅程。后退一步，前进两步，正视自己拖延的问题，跟拖延说拜拜，迎接更好的自己。</p>
<p><strong>附录：</strong></p>
<ul>
<li>两本拖延的书《拖延心理学》，《战胜拖延症》</li>
<li>拖延造成身体损害来自《心理学与生活》<br><img src="/images/书1.jpg" alt="Alt text"><br><img src="/images/书2.jpg" alt="Alt text"></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/08/Shell script backup MySQL summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WARREN's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/08/Shell script backup MySQL summary/" itemprop="url">Shell脚本备份MySQL总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-08T10:18:38+08:00">
                2016-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shell/" itemprop="url" rel="index">
                    <span itemprop="name">shell</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shell/Mysql/" itemprop="url" rel="index">
                    <span itemprop="name">Mysql</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shell/Mysql/备份/" itemprop="url" rel="index">
                    <span itemprop="name">备份</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Shell脚本备份MySQL总结"><a href="#Shell脚本备份MySQL总结" class="headerlink" title="Shell脚本备份MySQL总结"></a>Shell脚本备份MySQL总结</h3><p><strong>需求：</strong><br>备份策略：每天一次增量，每周一次全量<br>备份方式：至少两种，并且可以通过传参选择<br>通知策略：备份失败，发送通知<br>存储方式：按日期为文件名存储，本地和异地备份<br>回收机制：可配置备份文件保留时间<br>代码管理：将代码提交到公司git库里<br><strong>梳理：</strong><br>1.mysqldump和xtrabackup两种备份方式通过两个脚本来实现<br>2.选择增量或全量备份方式通过判断日期来决定<br>3.备份成功，保存异地；备份失败，发送通知邮件<br>(在这里把邮箱地址写到了一个文件里，可以随便增加邮箱，发邮件的时候读取这个文件，实现可以同时发给多人的功能。)<br>4.根据传入的时间决定删除哪些老备份</p>
<h5 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h5><p><img src="/images/MY流程图.png" alt="Alt text"></p>
<h5 id="模块实现-以xtrabackup为例"><a href="#模块实现-以xtrabackup为例" class="headerlink" title="模块实现(以xtrabackup为例)"></a>模块实现(以xtrabackup为例)</h5><p><strong>0.依赖软件安装</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ ! -x /usr/bin/innobackupex ] ; <span class="keyword">then</span></div><div class="line">	yum -y install xtrabackup</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! -x /usr/bin/mutt ] ; <span class="keyword">then</span></div><div class="line">	yum -y install sendmail mailx mutt</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure></p>
<p><strong>1.显示帮助</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>()</div><div class="line">&#123;</div><div class="line">cat &lt;&lt;EOF</div><div class="line">Usage: <span class="variable">$0</span> [configure-options]</div><div class="line">  -?, --help                Show this <span class="built_in">help</span> message.</div><div class="line">  --backup-dir=&lt;&gt;          Set backup directory</div><div class="line">  --defaults-file=[]        Set mysql configuration file directory</div><div class="line">  --host=&lt;&gt;              Set mysql host</div><div class="line">  --port=&lt;&gt;              Set mysql port                                                 </div><div class="line">  --user=&lt;&gt;              Set mysql user name                                            </div><div class="line">  --password=&lt;&gt;          Set mysql user password                                        </div><div class="line">  --retention=&lt;&gt;         Set backfile exist day                                         </div><div class="line">  --other_host=&lt;&gt;        Set long_range backup host                                     </div><div class="line">EOF                                                                                     </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>2.参数取值</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_key_value</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> | sed <span class="string">'s/^--[a-zA-Z_-]*=//'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>3.变量赋值</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">    usage</div><div class="line"><span class="comment">#     print_default</span></div><div class="line">    <span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">parse_options</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">while</span> <span class="built_in">test</span> <span class="variable">$#</span> <span class="_">-gt</span> 0</div><div class="line">  <span class="keyword">do</span></div><div class="line">  <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">  --backup-dir=*)</div><div class="line">    backupDir=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --defaults-file=*)</div><div class="line">    defaultFile=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --host=*)</div><div class="line">    Host=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --port=*)</div><div class="line">    mysqlPort=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --user=*)</div><div class="line">    mysqlUser=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --password=*)</div><div class="line">    mysqlPassword=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --retention=*)</div><div class="line">    retention=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --other_host=*)</div><div class="line">    other_host=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  -? | --help )</div><div class="line">    usage</div><div class="line"><span class="comment">#     print_default</span></div><div class="line">    <span class="built_in">exit</span> 0;;</div><div class="line">  *)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"Unknown option '<span class="variable">$1</span>'"</span></div><div class="line">    <span class="built_in">exit</span> 1;;</div><div class="line">  <span class="keyword">esac</span></div><div class="line">  <span class="built_in">shift</span></div><div class="line">  <span class="keyword">done</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>4.初始化环境</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">parse_options <span class="string">"<span class="variable">$@</span>"</span></div><div class="line">physicalBackupDir=<span class="variable">$&#123;backupDir&#125;</span>/physical</div><div class="line"><span class="built_in">log</span>Dir=<span class="variable">$&#123;backupDir&#125;</span>/<span class="built_in">log</span></div><div class="line">checkPointDir=<span class="variable">$&#123;backupDir&#125;</span>/checkpoint</div><div class="line">cmdInno=/usr/bin/innobackupex</div><div class="line">sock=/var/lib/mysql/mysql.sock</div><div class="line">day=`date +%w`</div><div class="line">lastday=`date <span class="_">-d</span> <span class="string">'1 days ago'</span> +%Y%m%d`</div><div class="line">dt=`date +%Y%m%d`</div><div class="line">ts=`date +%Y%m%d%H%M%S`</div><div class="line"><span class="built_in">log</span>File=<span class="variable">$&#123;backupDir&#125;</span>/<span class="built_in">log</span>/innobak_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;day&#125;</span>"</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">   <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>"</span> ];<span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"mkdir -p <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>"</span></div><div class="line">    mkdir -p <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$defaultFile</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  defaultFile=/etc/my.cnf</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$&#123;logDir&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  mkdir -p <span class="variable">$&#123;logDir&#125;</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$&#123;checkPointDir&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  mkdir -p <span class="variable">$&#123;checkPointDir&#125;</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Start innobackup at `date`."</span>             &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current defaults file is : <span class="variable">$&#123;defaultFile&#125;</span>"</span> &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current host is : <span class="variable">$&#123;Host&#125;</span>"</span>                 &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current port is : <span class="variable">$&#123;mysqlPort&#125;</span>"</span>           &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current mysql user is : <span class="variable">$&#123;mysqlUser&#125;</span>"</span>   &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current password is : <span class="variable">$&#123;mysqlPassword&#125;</span>"</span>   </div><div class="line"><span class="built_in">echo</span> <span class="string">"Current log directory is : <span class="variable">$&#123;logDir&#125;</span>"</span>   &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current log file is : <span class="variable">$&#123;logFile&#125;</span>"</span>       &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div></pre></td></tr></table></figure></p>
<p><strong>5.定义全量备份和增量备份的函数</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">back_full</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \</span></div><div class="line">    --no-timestamp <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>/base_<span class="variable">$&#123;dt&#125;</span> \</div><div class="line">    --socket=<span class="variable">$sock</span> 2&gt; <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log" &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">   <span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \</div><div class="line">    --no-timestamp <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>/base_<span class="variable">$&#123;dt&#125;</span> --socket=<span class="variable">$sock</span> 2&gt; <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line">   grep last_lsn <span class="variable">$physicalBackupDir</span>/<span class="variable">$&#123;dt&#125;</span>/base_<span class="variable">$&#123;dt&#125;</span>/xtrabackup_checkpoints|cut -b 12- &gt;<span class="variable">$checkPointDir</span>/ckp_<span class="variable">$&#123;dt&#125;</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">back_inc</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \  </span></div><div class="line">   --socket=<span class="variable">$sock</span> --no-timestamp --incremental <span class="variable">$basedir</span>/inc_<span class="variable">$&#123;dt&#125;</span> \</div><div class="line">   --incremental-lsn=`cat <span class="variable">$checkPointDir</span>/ckp_<span class="variable">$lastday</span>` 2&gt;<span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log" &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">  <span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \</div><div class="line">   --socket=<span class="variable">$sock</span> --no-timestamp --incremental <span class="variable">$basedir</span>/inc_<span class="variable">$&#123;dt&#125;</span> \</div><div class="line">   --incremental-lsn=`cat <span class="variable">$checkPointDir</span>/ckp_<span class="variable">$lastday</span>` 2&gt;<span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line">  grep last_lsn <span class="variable">$basedir</span>/inc_<span class="variable">$dt</span>/xtrabackup_checkpoints|cut -b 12- &gt;<span class="variable">$checkPointDir</span>/ckp_<span class="variable">$&#123;dt&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>6.根据日期调用不同函数</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="variable">$day</span> <span class="keyword">in</span></div><div class="line">  0)</div><div class="line">    <span class="comment"># Sunday Full backup</span></div><div class="line">    back_full</div><div class="line">    ;;</div><div class="line">  1)</div><div class="line">    <span class="comment"># Monday Relatively Sunday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"1 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  2)</div><div class="line">    <span class="comment"># Tuesday Compared with Monday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"2 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  3)</div><div class="line">    <span class="comment"># Wednesday Compared with Tuesday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"3 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  4)</div><div class="line">    <span class="comment"># Thursday Compared with Wednesday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"4 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  5)</div><div class="line">    <span class="comment"># Friday Compared with Thursday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"5 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  6)</div><div class="line">    <span class="comment"># Saturday Compared with Friday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"6 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure></p>
<p><strong>7.异地备份，发送邮件及删除旧备份文件(在这里引用了mail.sh，里面保存的是邮箱地址)</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$retention</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  retention=7</div><div class="line"><span class="keyword">fi</span></div><div class="line">find <span class="variable">$&#123;physicalBackupDir&#125;</span> -type f -mtime +<span class="variable">$retention</span> -exec rm &#123;&#125; \;</div><div class="line">find <span class="variable">$&#123;logDir&#125;</span> -type f -mtime +<span class="variable">$retention</span> -exec rm &#123;&#125; \;</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span> &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Below is detail log for current innobackup."</span>&gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">cat <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"></div><div class="line"></div><div class="line">. mail.sh</div><div class="line"><span class="built_in">echo</span> <span class="variable">$mailadd</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="keyword">if</span> [ <span class="_">-e</span> <span class="string">"<span class="variable">$&#123;logFile&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">   status=`grep -i <span class="string">"completed OK!"</span> <span class="variable">$&#123;logFile&#125;</span>`</div><div class="line">   <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$&#123;status&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    tar zcf innobackup_<span class="variable">$dt</span>.tar.gz <span class="variable">$backupDir</span> </div><div class="line">    scp /root/innobackup_<span class="variable">$dt</span>.tar.gz <span class="variable">$other_host</span>:/data/ &gt;/dev/null 2&gt;&amp;1</div><div class="line">    <span class="keyword">if</span> [ $? = 0 ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$db_back</span> 数据库备份传送到服务器:<span class="variable">$other_host</span> 完成"</span> &gt;&gt; <span class="variable">$&#123;logFile&#125;</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$db_back</span> 数据库备份传送到服务器:<span class="variable">$other_host</span> 失败,请查看邮件！"</span> &gt;&gt; <span class="variable">$&#123;logFile&#125;</span></div><div class="line">        cat <span class="variable">$&#123;logFile&#125;</span> |mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl hotbackup on <span class="variable">$other_host</span>."</span> <span class="variable">$mailadd</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">   <span class="keyword">else</span></div><div class="line">    cat <span class="variable">$&#123;logFile&#125;</span> |mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl hotbackup on `hostname`."</span> <span class="variable">$mailadd</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">else</span></div><div class="line">   <span class="built_in">echo</span> <span class="string">"The hotbackup logfile was not found on `hostname`."</span> | \</div><div class="line">   mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl hotbackup on `hostname`."</span> <span class="variable">$mailadd</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure></p>
<h5 id="引用的文件"><a href="#引用的文件" class="headerlink" title="引用的文件"></a>引用的文件</h5><p>mail.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">mailadd=<span class="string">"18883284060@163.com</span></div><div class="line">695944190@qq.com"</div><div class="line"><span class="built_in">export</span> mailadd</div></pre></td></tr></table></figure></p>
<h5 id="完整脚本-xtrabackup和mysqldump"><a href="#完整脚本-xtrabackup和mysqldump" class="headerlink" title="完整脚本(xtrabackup和mysqldump)"></a>完整脚本(xtrabackup和mysqldump)</h5><p><strong>innobk2.sh</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div></pre></td><td class="code"><pre><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="comment"># File	 : innobk.sh														   #</span></div><div class="line"><span class="comment"># Author   : HuTao														       #</span></div><div class="line"><span class="comment"># Blog	 : http://ancientmoonhu.github.io/									   #</span></div><div class="line"><span class="comment"># Date	 : 20160331														  	   #</span></div><div class="line"><span class="comment"># Description :																   #</span></div><div class="line"><span class="comment">#	The script will call innobackupex to									   #</span></div><div class="line"><span class="comment">#	take a full or increment backup for mysql db.							   #</span></div><div class="line"><span class="comment">#	Currently it will take follow principal to backup:						   #</span></div><div class="line"><span class="comment">#	   Sun take full backup.											       #</span></div><div class="line"><span class="comment">#	   Mon,Tue,Wend,Thur,Fri,Sat take incremental backup.					   #</span></div><div class="line"><span class="comment">#																			   #</span></div><div class="line"><span class="comment"># Usage Example:															   #</span></div><div class="line"><span class="comment">#	 innobk.sh --help|-?													   #</span></div><div class="line"><span class="comment">#	 innobk.sh --backup-dir=/dbbak --defaults-file=/etc/my.cnf \	           #</span></div><div class="line"><span class="comment">#			   --host=127.0.0.1 --port=3306 --user=xxx --password=xxx	       #</span></div><div class="line"><span class="comment">#																			   #</span></div><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="comment"># Change History:															   #</span></div><div class="line"><span class="comment"># --------------------------------------------------						   #</span></div><div class="line"><span class="comment"># Init Development	HuTao		2016-03-31									   #</span></div><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#set -x</span></div><div class="line"></div><div class="line"><span class="comment"># 依赖软件安装</span></div><div class="line"><span class="keyword">if</span> [ ! -x /usr/bin/innobackupex ] ; <span class="keyword">then</span></div><div class="line">        yum -y install xtrabackup</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! -x /usr/bin/mutt ] ; <span class="keyword">then</span></div><div class="line">        yum -y install sendmail mailx mutt</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># 取得输入参数的值</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_key_value</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> | sed <span class="string">'s/^--[a-zA-Z_-]*=//'</span> </div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 显示帮助</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>()</div><div class="line">&#123;</div><div class="line">cat &lt;&lt;EOF</div><div class="line">Usage: <span class="variable">$0</span> [configure-options]</div><div class="line">  -?, --help				Show this <span class="built_in">help</span> message.</div><div class="line">  --backup-dir=&lt;&gt;		   Set backup directory</div><div class="line">  --defaults-file=[]		Set mysql configuration file directory</div><div class="line">  --host=&lt;&gt;				 Set mysql host</div><div class="line">  --port=&lt;&gt;				 Set mysql port</div><div class="line">  --user=&lt;&gt;				 Set mysql user name</div><div class="line">  --password=&lt;&gt;			 Set mysql user password</div><div class="line">  --retention=&lt;&gt;		 Set backfile exist day</div><div class="line">  --other_host=&lt;&gt;		 Set long_range backup host</div><div class="line">EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 变量赋值</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">    usage</div><div class="line"><span class="comment">#	  print_default</span></div><div class="line">    <span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">parse_options</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">while</span> <span class="built_in">test</span> <span class="variable">$#</span> <span class="_">-gt</span> 0</div><div class="line">  <span class="keyword">do</span></div><div class="line">  <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">  --backup-dir=*)</div><div class="line">    backupDir=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --defaults-file=*)</div><div class="line">    defaultFile=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --host=*)</div><div class="line">    Host=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --port=*)</div><div class="line">    mysqlPort=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --user=*)</div><div class="line">    mysqlUser=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --password=*)</div><div class="line">    mysqlPassword=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --retention=*)</div><div class="line">	retention=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --other_host=*)</div><div class="line">    other_host=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  -? | --help )</div><div class="line">    usage</div><div class="line"><span class="comment">#	  print_default</span></div><div class="line">    <span class="built_in">exit</span> 0;;</div><div class="line">  *)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"Unknown option '<span class="variable">$1</span>'"</span></div><div class="line">    <span class="built_in">exit</span> 1;;</div><div class="line">  <span class="keyword">esac</span></div><div class="line">  <span class="built_in">shift</span></div><div class="line">  <span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 初始化环境.</span></div><div class="line">parse_options <span class="string">"<span class="variable">$@</span>"</span></div><div class="line">physicalBackupDir=<span class="variable">$&#123;backupDir&#125;</span>/physical</div><div class="line"><span class="built_in">log</span>Dir=<span class="variable">$&#123;backupDir&#125;</span>/<span class="built_in">log</span></div><div class="line">checkPointDir=<span class="variable">$&#123;backupDir&#125;</span>/checkpoint</div><div class="line">cmdInno=/usr/bin/innobackupex</div><div class="line">sock=/var/lib/mysql/mysql.sock</div><div class="line">day=`date +%w`</div><div class="line">lastday=`date <span class="_">-d</span> <span class="string">'1 days ago'</span> +%Y%m%d`</div><div class="line">dt=`date +%Y%m%d`</div><div class="line">ts=`date +%Y%m%d%H%M%S`</div><div class="line"><span class="built_in">log</span>File=<span class="variable">$&#123;backupDir&#125;</span>/<span class="built_in">log</span>/innobak_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;day&#125;</span>"</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">   <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>"</span> ];<span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"mkdir -p <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>"</span></div><div class="line">    mkdir -p <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>	</div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$defaultFile</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  defaultFile=/etc/my.cnf</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$&#123;logDir&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  mkdir -p <span class="variable">$&#123;logDir&#125;</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$&#123;checkPointDir&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  mkdir -p <span class="variable">$&#123;checkPointDir&#125;</span></div><div class="line"><span class="keyword">fi</span>  </div><div class="line"><span class="built_in">echo</span> <span class="string">"Start innobackup at `date`."</span>			   &gt;&gt;<span class="variable">$&#123;logFile&#125;</span> </div><div class="line"><span class="built_in">echo</span> <span class="string">"Current defaults file is : <span class="variable">$&#123;defaultFile&#125;</span>"</span> &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current host is : <span class="variable">$&#123;Host&#125;</span>"</span>				 &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current port is : <span class="variable">$&#123;mysqlPort&#125;</span>"</span>			&gt;&gt;<span class="variable">$&#123;logFile&#125;</span>   </div><div class="line"><span class="built_in">echo</span> <span class="string">"Current mysql user is : <span class="variable">$&#123;mysqlUser&#125;</span>"</span>	  &gt;&gt;<span class="variable">$&#123;logFile&#125;</span>	</div><div class="line"><span class="built_in">echo</span> <span class="string">"Current password is : <span class="variable">$&#123;mysqlPassword&#125;</span>"</span>	</div><div class="line"><span class="built_in">echo</span> <span class="string">"Current log directory is : <span class="variable">$&#123;logDir&#125;</span>"</span>	  &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current log file is : <span class="variable">$&#123;logFile&#125;</span>"</span>		  &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 定义全量和增量函数</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">back_full</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \</span></div><div class="line">    --no-timestamp <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>/base_<span class="variable">$&#123;dt&#125;</span> \</div><div class="line">    --socket=<span class="variable">$sock</span> 2&gt; <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log" &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">   <span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \</div><div class="line">    --no-timestamp <span class="variable">$physicalBackupDir</span>/<span class="variable">$dt</span>/base_<span class="variable">$&#123;dt&#125;</span> --socket=<span class="variable">$sock</span> 2&gt; <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line">   grep last_lsn <span class="variable">$physicalBackupDir</span>/<span class="variable">$&#123;dt&#125;</span>/base_<span class="variable">$&#123;dt&#125;</span>/xtrabackup_checkpoints|cut -b 12- &gt;<span class="variable">$checkPointDir</span>/ckp_<span class="variable">$&#123;dt&#125;</span> </div><div class="line">&#125;</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">back_inc</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \  </span></div><div class="line">   --socket=<span class="variable">$sock</span> --no-timestamp --incremental <span class="variable">$basedir</span>/inc_<span class="variable">$&#123;dt&#125;</span> \</div><div class="line">   --incremental-lsn=`cat <span class="variable">$checkPointDir</span>/ckp_<span class="variable">$lastday</span>` 2&gt;<span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log" &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">  <span class="variable">$cmdInno</span> --defaults-file=<span class="variable">$defaultFile</span> --user=<span class="variable">$mysqlUser</span> --password=<span class="variable">$mysqlPassword</span> \</div><div class="line">   --socket=<span class="variable">$sock</span> --no-timestamp --incremental <span class="variable">$basedir</span>/inc_<span class="variable">$&#123;dt&#125;</span> \</div><div class="line">   --incremental-lsn=`cat <span class="variable">$checkPointDir</span>/ckp_<span class="variable">$lastday</span>` 2&gt;<span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line">  grep last_lsn <span class="variable">$basedir</span>/inc_<span class="variable">$dt</span>/xtrabackup_checkpoints|cut -b 12- &gt;<span class="variable">$checkPointDir</span>/ckp_<span class="variable">$&#123;dt&#125;</span> </div><div class="line">&#125;</div><div class="line"><span class="keyword">case</span> <span class="variable">$day</span> <span class="keyword">in</span></div><div class="line">  0)</div><div class="line">    <span class="comment"># Sunday Full backup</span></div><div class="line">    back_full</div><div class="line">    ;;</div><div class="line">  1)</div><div class="line">    <span class="comment"># Monday Relatively Sunday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"1 days ago"</span> +%Y%m%d` </div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  2)</div><div class="line">    <span class="comment"># Tuesday Compared with Monday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"2 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  3)</div><div class="line">    <span class="comment"># Wednesday Compared with Tuesday's incremental backup</span></div><div class="line">	basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"3 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  4)</div><div class="line">    <span class="comment"># Thursday Compared with Wednesday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"4 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  5)</div><div class="line">    <span class="comment"># Friday Compared with Thursday's incremental backup</span></div><div class="line">    basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"5 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line">  6)</div><div class="line">    <span class="comment"># Saturday Compared with Friday's incremental backup</span></div><div class="line">     basedir=<span class="variable">$physicalBackupDir</span>/`date <span class="_">-d</span> <span class="string">"6 days ago"</span> +%Y%m%d`</div><div class="line">    back_inc</div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 回收机制</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$retention</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  retention=7</div><div class="line"><span class="keyword">fi</span></div><div class="line">find <span class="variable">$&#123;physicalBackupDir&#125;</span> -type f -mtime +<span class="variable">$retention</span> -exec rm &#123;&#125; \;</div><div class="line">find <span class="variable">$&#123;logDir&#125;</span> -type f -mtime +<span class="variable">$retention</span> -exec rm &#123;&#125; \;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 发送邮件并异地备份</span></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span> &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Below is detail log for current innobackup."</span>&gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">cat <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">. mail.sh</div><div class="line"><span class="built_in">echo</span> <span class="variable">$mailadd</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="keyword">if</span> [ <span class="_">-e</span> <span class="string">"<span class="variable">$&#123;logFile&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">   status=`grep -i <span class="string">"completed OK!"</span> <span class="variable">$&#123;logFile&#125;</span>`</div><div class="line">   <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$&#123;status&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    tar zcf inno_<span class="variable">$dt</span>.tar.gz <span class="variable">$backupDir</span></div><div class="line">    scp /root/inno_<span class="variable">$dt</span>.tar.gz <span class="variable">$other_host</span>:/data/ &gt;/dev/null 2&gt;&amp;1</div><div class="line">	<span class="keyword">if</span> [ $? = 0 ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"数据库备份传送到服务器:<span class="variable">$other_host</span> 完成"</span> &gt;&gt; <span class="variable">$&#123;logFile&#125;</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"数据库备份传送到服务器:<span class="variable">$other_host</span> 失败,请查看！"</span> &gt;&gt; <span class="variable">$&#123;logFile&#125;</span></div><div class="line">        cat <span class="variable">$&#123;logFile&#125;</span> |mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl hotbackup on <span class="variable">$other_host</span>."</span> <span class="variable">$mailadd</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">   <span class="keyword">else</span> </div><div class="line">    cat <span class="variable">$&#123;logFile&#125;</span> |mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl hotbackup on `hostname`."</span> <span class="variable">$mailadd</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">else</span></div><div class="line">   <span class="built_in">echo</span> <span class="string">"The hotbackup logfile was not found on `hostname`."</span> | \</div><div class="line">   mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl hotbackup on `hostname`."</span> <span class="variable">$mailadd</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure></p>
<p><strong>mysqldump.sh</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div></pre></td><td class="code"><pre><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="comment"># File	 : mysqldump.sh														   #</span></div><div class="line"><span class="comment"># Author   : HuTao														       #</span></div><div class="line"><span class="comment"># Blog	 : http://ancientmoonhu.github.io/									   #</span></div><div class="line"><span class="comment"># Date	 : 20160331														  	   #</span></div><div class="line"><span class="comment"># Description :																   #</span></div><div class="line"><span class="comment">#	The script will call innobackupex to									   #</span></div><div class="line"><span class="comment">#	take a full or increment backup for mysql db.							   #</span></div><div class="line"><span class="comment">#	Currently it will take follow principal to backup:						   #</span></div><div class="line"><span class="comment">#	   Sun take full backup.											       #</span></div><div class="line"><span class="comment">#	   Mon,Tue,Wend,Thur,Fri,Sat take incremental backup.					   #</span></div><div class="line"><span class="comment">#																			   #</span></div><div class="line"><span class="comment"># Usage Example:															   #</span></div><div class="line"><span class="comment">#	 mysqldump.sh --help|-?													   #</span></div><div class="line"><span class="comment">#	 mysqldump.sh --backup-dir=/dbbak --defaults-file=/etc/my.cnf \	           #</span></div><div class="line"><span class="comment">#			   --host=127.0.0.1 --port=3306 --user=xxx --password=xxx	       #</span></div><div class="line"><span class="comment">#																			   #</span></div><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="comment"># Change History:															   #</span></div><div class="line"><span class="comment"># --------------------------------------------------						   #</span></div><div class="line"><span class="comment"># Init Development	HuTao		2016-03-31									   #</span></div><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#set -x</span></div><div class="line"></div><div class="line"><span class="comment"># 依赖软件安装</span></div><div class="line"><span class="keyword">if</span> [ ! -x /usr/bin/mysqldump ] ; <span class="keyword">then</span></div><div class="line">        yum -y install mysql</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! -x /usr/bin/mutt ] ; <span class="keyword">then</span></div><div class="line">        yum -y install sendmail mailx mutt</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># 取得输入参数的值</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_key_value</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> | sed <span class="string">'s/^--[a-zA-Z_-]*=//'</span> </div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 显示帮助</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>()</div><div class="line">&#123;</div><div class="line">cat &lt;&lt;EOF</div><div class="line">Usage: <span class="variable">$0</span> [configure-options]</div><div class="line">  -?, --help				Show this <span class="built_in">help</span> message.</div><div class="line">  --backup-dir=&lt;&gt;		   Set backup directory</div><div class="line">  --defaults-file=[]		Set mysql configuration file directory</div><div class="line">  --host=&lt;&gt;				 Set mysql host</div><div class="line">  --port=&lt;&gt;				 Set mysql port</div><div class="line">  --user=&lt;&gt;				 Set mysql user name</div><div class="line">  --password=&lt;&gt;			 Set mysql user password</div><div class="line">  --retention=&lt;&gt;		 Set backfile exist day</div><div class="line">  --other_host=&lt;&gt;		 Set long_range backup host</div><div class="line">EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 变量赋值</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">    usage</div><div class="line"><span class="comment">#	  print_default</span></div><div class="line">    <span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">parse_options</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">while</span> <span class="built_in">test</span> <span class="variable">$#</span> <span class="_">-gt</span> 0</div><div class="line">  <span class="keyword">do</span></div><div class="line">  <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">  --backup-dir=*)</div><div class="line">    backupDir=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --defaults-file=*)</div><div class="line">    defaultFile=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --host=*)</div><div class="line">    Host=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --port=*)</div><div class="line">    mysqlPort=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --user=*)</div><div class="line">    mysqlUser=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --password=*)</div><div class="line">    mysqlPassword=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --retention=*)</div><div class="line">	retention=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  --other_host=*)</div><div class="line">    other_host=`get_key_value <span class="string">"<span class="variable">$1</span>"</span>`;;</div><div class="line">  -? | --help )</div><div class="line">    usage</div><div class="line"><span class="comment">#	  print_default</span></div><div class="line">    <span class="built_in">exit</span> 0;;</div><div class="line">  *)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"Unknown option '<span class="variable">$1</span>'"</span></div><div class="line">    <span class="built_in">exit</span> 1;;</div><div class="line">  <span class="keyword">esac</span></div><div class="line">  <span class="built_in">shift</span></div><div class="line">  <span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 初始化环境.</span></div><div class="line">parse_options <span class="string">"<span class="variable">$@</span>"</span></div><div class="line"><span class="built_in">log</span>Dir=<span class="variable">$&#123;backupDir&#125;</span>/<span class="built_in">log</span></div><div class="line">cmdInno=/usr/bin/mysqldump</div><div class="line">sock=/var/lib/mysql/mysql.sock</div><div class="line">day=`date +%w`</div><div class="line">lastday=`date <span class="_">-d</span> <span class="string">'1 days ago'</span> +%Y%m%d`</div><div class="line">dt=`date +%Y%m%d`</div><div class="line">ts=`date +%Y%m%d%H%M%S`</div><div class="line"><span class="built_in">log</span>File=<span class="variable">$logDir</span>/mysqldump_<span class="variable">$&#123;ts&#125;</span>.log</div><div class="line">dataDir=/var/lib/mysql</div><div class="line">gzdumpfile=<span class="string">"<span class="variable">$date</span>.sql.gz"</span></div><div class="line">db=<span class="string">"<span class="variable">$logDir</span>/backup_<span class="variable">$date</span>.txt"</span></div><div class="line">Start=<span class="string">"--start-datetime"</span></div><div class="line">ls <span class="_">-l</span> <span class="variable">$dataDir</span> | grep <span class="string">"^d"</span> | awk -F <span class="string">" "</span> <span class="string">'&#123;print $9&#125;'</span> &gt; <span class="variable">$db</span></div><div class="line">filename=`cat <span class="variable">$dataDir</span>/mysql-bin.index | awk -F <span class="string">"/"</span> <span class="string">'&#123;print $NF&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;day&#125;</span>"</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">       <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$backupDir</span>/full"</span> ];<span class="keyword">then</span></div><div class="line">               <span class="built_in">echo</span> <span class="string">"mkdir -p <span class="variable">$backupDir</span>/full"</span></div><div class="line">               mkdir -p <span class="variable">$backupDir</span>/full</div><div class="line">       <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="variable">$backdir</span>/inc ];<span class="keyword">then</span></div><div class="line">    mkdir -p <span class="variable">$backupDir</span>/inc</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$defaultFile</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  defaultFile=/etc/my.cnf</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$&#123;logDir&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  mkdir -p <span class="variable">$&#123;logDir&#125;</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Start mysqldump at `date`."</span>			   &gt;&gt;<span class="variable">$&#123;logFile&#125;</span> </div><div class="line"><span class="built_in">echo</span> <span class="string">"Current defaults file is : <span class="variable">$&#123;defaultFile&#125;</span>"</span> &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current host is : <span class="variable">$&#123;Host&#125;</span>"</span>				 &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current port is : <span class="variable">$&#123;mysqlPort&#125;</span>"</span>			&gt;&gt;<span class="variable">$&#123;logFile&#125;</span>   </div><div class="line"><span class="built_in">echo</span> <span class="string">"Current mysql user is : <span class="variable">$&#123;mysqlUser&#125;</span>"</span>	  &gt;&gt;<span class="variable">$&#123;logFile&#125;</span>	</div><div class="line"><span class="built_in">echo</span> <span class="string">"Current password is : <span class="variable">$&#123;mysqlPassword&#125;</span>"</span>	</div><div class="line"><span class="built_in">echo</span> <span class="string">"Current log directory is : <span class="variable">$&#123;logDir&#125;</span>"</span>	  &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Current log file is : <span class="variable">$&#123;logFile&#125;</span>"</span>		  &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 定义全量和增量函数</span></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">mysqldump_full</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">cd</span> <span class="variable">$backupDir</span>/full</div><div class="line"><span class="keyword">for</span> dbname <span class="keyword">in</span> $(cat <span class="variable">$db</span>);</div><div class="line"><span class="keyword">do</span></div><div class="line">    mysqldump --ignore-table=mysql.event --flush-logs --skip-lock-tables -u<span class="variable">$mysqlUser</span> -p<span class="variable">$mysqlPassword</span> <span class="variable">$dbname</span> | gzip &gt; <span class="variable">$dbname</span>.<span class="variable">$gzdumpfile</span></div><div class="line">    <span class="keyword">if</span> [ $? = 0 ] ; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$dbname</span> 数据库备份成功"</span> &gt;&gt; <span class="variable">$logFile</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$dbname</span> 数据库备份失败，请查看日志！"</span> &gt;&gt; <span class="variable">$logFile</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">mysqldump_inc</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">cd</span> <span class="variable">$dataDir</span>/inc</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$filename</span>;</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">for</span> db_name <span class="keyword">in</span> $(cat <span class="variable">$db</span>);</div><div class="line">    <span class="keyword">do</span></div><div class="line">        mysqlbinlog -u<span class="variable">$mysqlUser</span> -p<span class="variable">$mysqlPassword</span> <span class="_">-d</span> <span class="variable">$db_name</span> <span class="variable">$Start</span>=<span class="string">"<span class="variable">$lastday</span>"</span> <span class="variable">$dataDir</span>/<span class="variable">$i</span> | gzip &gt;&gt; <span class="variable">$db_name</span>.<span class="variable">$gzdumpfile</span></div><div class="line">        <span class="keyword">if</span> [ $? = 0 ] ;</div><div class="line">        <span class="keyword">then</span></div><div class="line">            <span class="built_in">echo</span> <span class="string">"<span class="variable">$db_name</span> 数据库的<span class="variable">$i</span> 二进制日志增量备份成功"</span> &gt;&gt; <span class="variable">$logFile</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">echo</span> <span class="string">"<span class="variable">$db_name</span> 数据库的<span class="variable">$i</span> 二进制日志增量备份失败，请查看日志！"</span> &gt;&gt; <span class="variable">$logFile</span></div><div class="line">        <span class="keyword">fi</span></div><div class="line">    <span class="keyword">done</span></div><div class="line"><span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">case</span> <span class="variable">$day</span> <span class="keyword">in</span></div><div class="line">  0)</div><div class="line">    <span class="comment"># Sunday Full backup</span></div><div class="line">    mysqldump_full</div><div class="line">    ;;</div><div class="line">  1)</div><div class="line">    ;;</div><div class="line">  2)</div><div class="line">    ;;</div><div class="line">  3)</div><div class="line">    ;;</div><div class="line">  4)</div><div class="line">    ;;</div><div class="line">  5)</div><div class="line">    ;;</div><div class="line">  6)</div><div class="line">    mysqldump_inc</div><div class="line">    ;;</div><div class="line"><span class="keyword">esac</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 回收机制</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$retention</span>"</span> ]; <span class="keyword">then</span></div><div class="line">  retention=7</div><div class="line"><span class="keyword">fi</span></div><div class="line">find <span class="variable">$&#123;backupDir&#125;</span> -type f -mtime +<span class="variable">$retention</span> -exec rm &#123;&#125; \;</div><div class="line">find <span class="variable">$&#123;logDir&#125;</span> -type f -mtime +<span class="variable">$retention</span> -exec rm &#123;&#125; \;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 发送邮件及异地备份</span></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span> &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Below is detail log for current mysqldump."</span>&gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">cat <span class="variable">$&#123;logDir&#125;</span>/bak_<span class="variable">$&#123;ts&#125;</span>.log &gt;&gt;<span class="variable">$&#123;logFile&#125;</span></div><div class="line">. mail.sh</div><div class="line"><span class="built_in">echo</span> <span class="variable">$mailadd</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="keyword">if</span> [ <span class="_">-e</span> <span class="string">"<span class="variable">$&#123;logFile&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">   status=`grep -i <span class="string">"备份成功"</span> <span class="variable">$&#123;logFile&#125;</span>`</div><div class="line">   <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$&#123;status&#125;</span>"</span> ]; <span class="keyword">then</span></div><div class="line">          tar zcf mysqldump_<span class="variable">$date</span>.tar.gz <span class="variable">$backupDir</span></div><div class="line">          scp /root/mysqldump_<span class="variable">$date</span>.tar.gz <span class="variable">$other_host</span>:/data/ &gt;/dev/null 2&gt;&amp;1</div><div class="line">	      <span class="keyword">if</span> [ $? = 0 ]</div><div class="line">          <span class="keyword">then</span></div><div class="line">              <span class="built_in">echo</span> <span class="string">"数据库备份传送到服务器:<span class="variable">$other_host</span> 完成"</span> &gt;&gt; <span class="variable">$&#123;logFile&#125;</span></div><div class="line">          <span class="keyword">else</span></div><div class="line">              <span class="built_in">echo</span> <span class="string">"数据库备份传送到服务器:<span class="variable">$other_host</span> 失败,请查看！"</span> &gt;&gt; <span class="variable">$&#123;logFile&#125;</span></div><div class="line">              cat <span class="variable">$&#123;logFile&#125;</span> |mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl logicbackup on <span class="variable">$other_host</span>."</span> <span class="variable">$mailadd</span></div><div class="line">          <span class="keyword">fi</span></div><div class="line">   <span class="keyword">else</span> </div><div class="line">    cat <span class="variable">$&#123;logFile&#125;</span> |mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl logicbackup on `hostname`."</span> <span class="variable">$mailadd</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">else</span></div><div class="line">   <span class="built_in">echo</span> <span class="string">"The logicbackup logfile was not found on `hostname`."</span> | \</div><div class="line">   mutt <span class="_">-s</span> <span class="string">"Failed backup for MySQl logicbackup on `hostname`."</span> <span class="variable">$mailadd</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/01/PXC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WARREN's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/01/PXC/" itemprop="url">PXC（Percona XtraDB Cluster）集群安装，以及关于mysql主从复制的概述与分类</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-01T18:45:13+08:00">
                2016-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PXC/" itemprop="url" rel="index">
                    <span itemprop="name">PXC</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PXC/Mysql/" itemprop="url" rel="index">
                    <span itemprop="name">Mysql</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PXC/Mysql/集群/" itemprop="url" rel="index">
                    <span itemprop="name">集群</span>
                  </a>
                </span>

                
                
                  . 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PXC/Mysql/集群/M-S/" itemprop="url" rel="index">
                    <span itemprop="name">M/S</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> <strong>操作系统</strong> ：Centos 6.4 64位 Basic Server安装<br> <strong>软件版本</strong> ：5.6.28-76.1-56 Percona XtraDB Cluster (GPL)</p>
<p><strong>节点信息</strong> ：</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>Node Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.80.137</td>
<td>db1.test.com</td>
<td>db_01</td>
</tr>
<tr>
<td>192.168.80.138</td>
<td>db2.test.com</td>
<td>db_02</td>
</tr>
<tr>
<td>192.168.80.136</td>
<td>db3.test.com</td>
<td>db_03</td>
</tr>
</tbody>
</table>
<p>在 DNS 里解析主机名，或者在 host 文件里加入下面的内容：</p>
<pre><code>192.168.80.136 db3.test.com
192.168.80.137 db1.test.com
192.168.80.138 db2.test.com
</code></pre><p>开放 iptables 端口限制</p>
<pre><code>#注意只暴露给内网对应的设备
iptables -I INPUT -p tcp --dport 3306 -j ACCEPT
iptables -I INPUT -p tcp --dport 4444 -j ACCEPT
iptables -I INPUT -p tcp --dport 4567 -j ACCEPT

#记得保存
/etc/init.d/iptables save
</code></pre><p>关闭 selinux</p>
<pre><code>setenforce 0
sed -i &apos;s/SELINUX=.*/SELINUX=disabled/&apos; /etc/selinux/config
</code></pre><h4 id="PXC安装过程"><a href="#PXC安装过程" class="headerlink" title="PXC安装过程"></a>PXC安装过程</h4><blockquote>
<p>Percona XtraDB Cluster 是 MySQL 高可用性和可扩展性的解决方案。Percona Server 是MySQL的改进版本，使用 XtraDB 存储引擎，在功能和性能上较 MySQL 有着很显著的提升，如提升了在高负载情况下的 InnoDB 的性能，Percona XtraDB Cluster 完全兼容 MySQL 和 Percona Server。    —— <a href="http://blog.tanchao.org/2015/12/15/install-pxc/" target="_blank" rel="external">OutMan の Blog</a></p>
</blockquote>
<p>在每个Node上执行下面的操作 </p>
<pre><code>#安装 epel 源
yum install http://mirrors.yun-idc.com/epel/6/i386/epel-release-6-8.noarch.rpm
#安装 percona 官方源
yum install http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm
</code></pre><p>（PS：我在这里碰到了安装percona官方源失败的情况<br><strong>解决方法</strong>：查看ll /etc/yum.repos.d/<br><strong>vi /etc/yum.repos.d/epel.repo</strong><br>编辑[epel]下的baseurl前的#号去掉，mirrorlist前添加#号<br>再运行yum makecache）</p>
<pre><code>#安装5.6版本
yum install Percona-XtraDB-Cluster-server-56
#mysql 加入自启动
chkconfig mysql on
</code></pre><p>每台机器开启PXC，之后添加SST账户：</p>
<pre><code>/etc/init.d/mysql start

#创建 sst 用户，不能用下面的弱密码
CREATE USER &apos;sstuser&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;password&apos;;    
GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO &apos;sstuser&apos;@&apos;localhost&apos;;          
FLUSH PRIVILEGES;
</code></pre><p>每个节点关闭PXC。编辑第一个节点的PXC设置。</p>
<pre><code>[mysqld]
#注意Server-id 应该每个机器不一样
server-id = 1
wsrep_provider=/usr/lib64/libgalera_smm.so
#这里指定到db_01的主机名 db1.test.com
wsrep_cluster_address=&quot;gcomm://db1.test.com,db2.test.com,db3.test.com&quot;
wsrep_sst_auth=&quot;sstuser:warren&quot;
wsrep_provider_options=&quot;gcache.size=2G&quot;
wsrep_cluster_name=Percona
#指定SST方式，支持rsync(最快，需要锁表)，mysqldump 和 xtrabackup
#从 5.5.33-23.7.6 起支持 xtrabackup-v2
#5.6 默认是 xtrabackup-v2 ,可以不配置这上选项，但不能配置为 xtrabackup
wsrep_sst_method=xtrabackup-v2
#节点的名称，每个机器要区别开来
wsrep_node_name=db_01
wsrep_slave_threads=4
binlog_format=ROW
log_slave_updates
innodb_locks_unsafe_for_binlog=1
innodb_autoinc_lock_mode=2
default_storage_engine=InnoDB
</code></pre><p>开启第一个节点（如果集群关闭，每次拥有正确信息的节点使用此命令开启集群）</p>
<pre><code>service mysql bootstrap-pxc
</code></pre><p>编辑另外两个节点的my.cnf配置文件需要修改的内容：</p>
<pre><code>server_id=2  
wsrep_node_name=db_02
</code></pre><p>将其他两个节点加入到集群中</p>
<pre><code>service mysql start
</code></pre><p>至此，集群安装结束。</p>
<h4 id="模拟PXC故障场景"><a href="#模拟PXC故障场景" class="headerlink" title="模拟PXC故障场景"></a>模拟PXC故障场景</h4><p><strong>测试条件：</strong>数据持续写入中<br>1，其中一个节点挂掉，恢复后加入集群</p>
<p>结果：成功加入，且没有数据丢失。</p>
<p>主节点<br> <img src="/images/1.1.png" alt="Alt text"></p>
<p>挂掉的节点<br> <img src="/images/1.2.png" alt="Alt text"></p>
<p>其他节点<br> <img src="/images/1.3.png" alt="Alt text"></p>
<p>2，其中一个节点data目录被删除后，加入集群</p>
<p>结果：加入成功，所有节点数据一致。</p>
<p>主节点<br> <img src="/images/2.1.png" alt="Alt text"></p>
<p>目录被删除的节点<br> <img src="/images/2.2.png" alt="Alt text"></p>
<p>其他节点<br> <img src="/images/2.3.png" alt="Alt text"></p>
<p>操作过程中通过查看日志发现：<br>4567这个端口是个管理端口，主要是用来加入和删除故障节点；<br>4444这个端口是用在加入集群后，通过全量（SST）的方式去同步所有节点的数据时用到的。</p>
<h4 id="关于mysql主从复制的概述与分类"><a href="#关于mysql主从复制的概述与分类" class="headerlink" title="关于mysql主从复制的概述与分类"></a>关于mysql主从复制的概述与分类</h4><blockquote>
<p>—— from <a href="http://www.cnblogs.com/abobo/p/4239220.html" target="_blank" rel="external">风之岚翔</a></p>
</blockquote>
<p>一、概述：</p>
<p>   按照MySQL的同步复制特点，大体上可以分为三种类别：</p>
<p>1、异步复制；</p>
<p>2、半同步复制；</p>
<p>3、完全同步的复制；</p>
<hr>
<p>（一）、异步复制：</p>
<p><strong>1、概念</strong></p>
<p>mysql的异步复制在业界中的叫法有很多，比如：AB复制、主从同步、mysql replication等等。说白了就是master和slave结构。在mysql5.6版本以后又进一步的细分成：传统的复制方法和全新的复制方法。</p>
<p><strong>2、5.6以后的mysql主从复制的分类：</strong></p>
<p>2.1、传统复制方法是按照binlog的三种日志格式进行划分的：</p>
<p>基于语句的复制，即statement模式。</p>
<p>基于行的复制，即row模式。</p>
<p>基于混合的复制，即mixed</p>
<p>2.2、全新的复制方法：基于GTID的复制。</p>
<p><strong>3、关于master和slave的关系：</strong></p>
<p>不是主备模式，而是数据镜像。</p>
<p>特别在GTID环境下，不能在slave上做dml操作。</p>
<p>slave拿到master上的日志，在slave上以串行的方式进行重放。</p>
<p>I/O现成是一个（串行），sql线程和DB一样多。</p>
<p>结构可以分为：一主一从、一主多从、双主多从。</p>
<p><strong>4、master和slave的作用：</strong></p>
<p>实现读写分离。</p>
<p>从库可以用作故障转移。(master挂了，vip切换到slave端)</p>
<p>用从库做备份，或者特殊统计。（一条大sql跑一下需要很久，可以单独找个slave单独来跑）</p>
<p>用于主库升级.（M端5.5，S端5.6，S端转换成M，将原M端升级成5.6然后挂载到5.6的M端）</p>
<p><strong>5、master和slave的工作原理：</strong><br>如图1：<br><img src="/images/下载.png" alt="Alt text"><br>master更新数据，写binlog；</p>
<p>slave在master端注册一个i/o thread进程，截取binlog日志的变更。</p>
<p>i/o thread接入日志变更之后写入到本地的relay log里。</p>
<p>然后通过sql thread到relay log里进行解析复制到slave端。</p>
<p>在解析过程中会判断是否有主键，如果没有在判断是否有二级索引，如果没有就进行全表扫描。</p>
<p><strong>6、判断主从同步的地址段参数：</strong><br>判断日志参数：</p>
<p>master_log_file:</p>
<p>relay_master_log_file:</p>
<p>判断地址参数：</p>
<p>read_master_log_pos:</p>
<p>exec_master_log_pos:</p>
<p>（二）、半同步复制：</p>
<p><strong>1、概念与作用</strong><br>　　在默认情况下，mysql复制功能是异步的，异步复制可以提供最佳性能。当主库把binlog日志发送给从库，这一动作就结束了，并不会验证从库是否接收到，或者接受完毕。这不仅带来了很高的风险，同时也意味着当master或者slave发证故障时，有可能slave端没有接收到主机发送过来的binlog日志，最终导致master/slave的数据不一致，甚至在恢复时造成数据丢失。<br>　　为了解决上述问题，mysql5.5引入了一种半同步复制模式，该模式可以确保slave端接收完master端发送的binlog日志文件写入自己的中继日志relay log里，然后会给master端一个ack。告诉对方已经接收完毕。这时master的线程才返回给当前session告知操作完成。</p>
<p><strong>2、注意事项：</strong></p>
<p>a、当出现超时的情况时，源主服务器会暂时切换到异步复制模式，直到至少有一台设置为半同步复制模式的slave端及时收到信息为止。</p>
<p>b、半同步复制模式必须在主服务器和从服务器端同时启用，否则主服务器默认使用异步复制模式。</p>
<p>c、slave在接收到二进制日志后会通过i/o_thread给master端一个ack。但是他并不会管relay-log中的sql_thread进程是否执行完。</p>
<p><strong>3、特点：</strong></p>
<p>半同步复制的目的是保证主从数据的一致性，等待返回的时间长短决定了数据库的更新速度。</p>
<p>优点：保证主从数据一致性。</p>
<p>缺点：更新、插入、删除的速度要比传统的异步复制稍慢一些，因为多了一个ACK的步骤。</p>
<p>　　  尤其是在网络受到波动的情况下，如丢包、ping延时，半同步复制和异步复制就会切来切去，也会导致主库的更新、插入、删除操作受到影响。</p>
<p><strong>4、原理图：</strong><br><img src="/images/下载 1.png" alt="Alt text"><br><img src="/images/下载 2.png" alt="Alt text"></p>
<p>（三）、完全同步复制：</p>
<p>由于半同步的这种弊端，在生产环境里一般用到的很少，但是为了保证节点之间的数据一致性。可以采用完全同步的方式—–PXC架构。</p>
<p><strong>1、概念：</strong></p>
<p>PXC在数据commit的时候需像其他主机成全进行确认，当有多个主机成员返回ACK时才可以commit数据。一般主句数量与返回ACK的数量如下：</p>
<p>5个节点，有三个节点回复。</p>
<p>3个节点，有一个节点回复。</p>
<p><strong>2、特点：</strong></p>
<p>对于数据库的数据一致性很高的场景。</p>
<p>PXC解决的是数据一致性的问题，而不是存储结构的问题。</p>
<p>几个节点可以跑同一个业务结构。同时下面也可以挂在slave端。</p>
<p>有些类似于oracle的rac功能，实现并发负载。只是没有共享存储，一般oracle转mysql用途比较多些。</p>
<p><strong>3、工作原理：</strong></p>
<p>a、在PXC集群中第一个节点会以mysql –wsrep_cluster_address=gcomm://192.168.100.200这种方式启动。其他节点会以/etc/init.d/mysql start的方式启动。</p>
<p>b、当第二个节点加入PXC集群后，会连接到node1上去请求数据，并查看GTID的节点。如果所有GTID的节点与新加入的节点不一致，就会通过全量（SST）的方式去同步所有节点的数据。此时提供node1数据提供住就被称为donor。</p>
<p>c、donor角色在同步数据前的时候会做一次SST的备份，此时备份过程中donor节点性能会变得非常差。因此，在跑PXC的服务器不要使用多实例。如果集群是能够在控制范围内的化，可以指定一个donor的主机进行数据同步，当节点传输完后直接删除参数即可。</p>
<p>参数如下：</p>
<p>vi /etc/my.cnf</p>
<p>wsrep_sst_donor=节点名</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">胡涛</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">Kategorien</span>
                
              </div>
            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">胡涛</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
